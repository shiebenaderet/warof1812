# v1.5.0 Onboarding Flow Redesign — Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Replace the single FactionSelect onboarding screen with a guided 5-step flow (Name → Difficulty → Learning → Quiz → Faction), add AI difficulty levels, and add a quiz gate.

**Architecture:** App.js gains an `onboardingStep` state machine that routes between 5 step components. Each step updates a shared `onboardingData` object. AI difficulty merges config overrides into the existing `AI_CONFIG` at runtime. Medium difficulty preserves current behavior exactly.

**Tech Stack:** React 19, Tailwind CSS, Supabase (one new column)

**Prerequisites:** User must run this SQL in Supabase before testing score submission:
```sql
ALTER TABLE scores ADD COLUMN difficulty text DEFAULT 'medium';
```

---

## Phase 1: AI Difficulty Data Layer (no UI changes, all tests keep passing)

### Task 1: Create difficultySettings.js

**Files:**
- Create: `src/data/difficultySettings.js`

**Step 1: Create the difficulty config file**

```js
/**
 * AI difficulty configuration overrides.
 * Medium values match current AI_CONFIG exactly (baseline).
 * Only parameters that differ from the base AI_CONFIG are listed per difficulty.
 */

export const DIFFICULTY_CONFIGS = {
  easy: {
    BASE_REINFORCEMENTS: 2,
    MAX_ATTACKS_PER_TURN: 2,
    MIN_ATTACK_PROBABILITY: 0.55,
    CONCENTRATION_RATIO: 0.2,
    TOP_N_ATTACK_CHOICES: 5,
    ATTACK_PROBABILITY_WEIGHT: 8,
    ATTACK_FORT_PENALTY: 5,
    MAX_TROOPS_TO_MOVE: 1,
    MAX_MANEUVERS: 1,
  },
  medium: {
    // No overrides — uses base AI_CONFIG values as-is
  },
  hard: {
    BASE_REINFORCEMENTS: 6,
    MAX_ATTACKS_PER_TURN: 7,
    MIN_ATTACK_PROBABILITY: 0.15,
    CONCENTRATION_RATIO: 0.6,
    TOP_N_ATTACK_CHOICES: 1,
    ATTACK_PROBABILITY_WEIGHT: 2,
    ATTACK_FORT_PENALTY: 1,
    MAX_TROOPS_TO_MOVE: 5,
    MAX_MANEUVERS: 5,
  },
};

export const DIFFICULTY_LABELS = {
  easy: { name: 'Learning', description: 'The AI takes it easy. Good for learning the game.' },
  medium: { name: 'Balanced', description: 'A fair challenge. The AI plays smart.' },
  hard: { name: 'Commander', description: 'The AI is aggressive and relentless. For experienced players.' },
};
```

**Step 2: Build to verify no breakage**

Run: `npx react-scripts build`
Expected: Compiled successfully (file is created but not imported yet)

**Step 3: Commit**

```
git add src/data/difficultySettings.js
git commit -m "Add difficulty config data for Easy/Medium/Hard AI"
```

---

### Task 2: Wire difficulty into gameReducer

**Files:**
- Modify: `src/reducers/gameReducer.js` (lines 37-70, 162-170)

**Step 1: Add `difficulty` to initial state**

In `getInitialGameState()` (line 47), add after `gameMode`:
```js
    difficulty: 'medium',
```

**Step 2: Add `difficulty` to GAME_START case**

In the GAME_START return (line 59-70), add after the `gameMode` line:
```js
    difficulty: action.payload.difficulty || 'medium',
```

**Step 3: Add `difficulty` to LOAD_GAME_STATE case**

In the LOAD_GAME_STATE return (line 162-170), add after the `gameMode` line:
```js
    difficulty: action.payload?.difficulty || 'medium',
```

**Step 4: Run tests**

Run: `npx react-scripts test --watchAll=false`
Expected: 105 tests pass (default value means no behavior change)

**Step 5: Commit**

```
git add src/reducers/gameReducer.js
git commit -m "Add difficulty field to game state (default medium)"
```

---

### Task 3: Wire difficulty through useGameStateV2 and useAI

**Files:**
- Modify: `src/hooks/useGameStateV2.js` (lines 341-368, 911-920, 1376-1463)
- Modify: `src/hooks/useAI.js` (lines 17-61, 194)

**Step 1: Update startGame to accept difficulty**

In `useGameStateV2.js`, update the `startGame` callback (line 341):
```js
const startGame = useCallback(({ faction, playerName: name, classPeriod: period, gameMode, difficulty }) => {
```

Update the GAME_START dispatch (line 354) to include `difficulty`:
```js
dispatchGame({ type: GAME_START, payload: { faction, name, period, gameMode, difficulty } });
```

**Step 2: Expose difficulty in return object**

In the return object (~line 1385, after `gameMode`), add:
```js
difficulty: gameState.difficulty,
```

**Step 3: Pass difficulty to runAITurn**

At the runAITurn call site (~line 911), add `gameState.difficulty` as the last argument:
```js
const result = runAITurn(
  faction,
  aiOwners,
  aiTroops,
  leaderState.leaderStates,
  eventState.invulnerableTerritories,
  gameState.round,
  gameState.difficulty
);
```

**Step 4: Update useAI.js to accept and apply difficulty**

Add import at top of `src/hooks/useAI.js`:
```js
import { DIFFICULTY_CONFIGS } from '../data/difficultySettings';
```

Update `runAITurn` signature (line 194):
```js
export function runAITurn(faction, territoryOwners, troops, leaderStates, invulnerableTerritories = [], round = 1, difficulty = 'medium')
```

At the very start of `runAITurn` body (after the opening brace), add:
```js
  const config = { ...AI_CONFIG, ...(DIFFICULTY_CONFIGS[difficulty] || {}) };
```

Then find-and-replace all occurrences of `AI_CONFIG.` with `config.` within the `runAITurn` function body ONLY (not outside it — the module-level `AI_CONFIG` constant stays unchanged). There are approximately 25+ references.

**Step 5: Run tests and build**

Run: `npx react-scripts test --watchAll=false`
Expected: 105 pass (medium difficulty = no overrides = identical behavior)

Run: `npx react-scripts build`
Expected: Compiled successfully

**Step 6: Commit**

```
git add src/hooks/useGameStateV2.js src/hooks/useAI.js
git commit -m "Wire difficulty through game state into AI config"
```

---

### Task 4: Wire difficulty into Supabase + ScoreSubmission

**Files:**
- Modify: `src/lib/supabase.js` (lines 13-54)
- Modify: `src/components/ScoreSubmission.jsx` (lines 31-80)
- Modify: `src/components/GameReport.jsx` (where ScoreSubmission is rendered)

**Step 1: Add difficulty to submitScore**

In `supabase.js`, add `difficulty` to the function parameter destructuring (~line 30):
```js
  gameOverReason,
  difficulty,
})
```

Add to the insert payload (~line 53):
```js
  game_over_reason: gameOverReason || 'treaty',
  difficulty: difficulty || 'medium',
```

**Step 2: Add difficulty prop to ScoreSubmission**

In `ScoreSubmission.jsx`, add `difficulty` to the props destructuring (~line 47):
```js
  gameOverReason,
  difficulty,
  onSubmitted,
```

Add to the submitScore call (~line 79):
```js
  gameOverReason,
  difficulty,
```

**Step 3: Pass difficulty from GameReport to ScoreSubmission**

In `GameReport.jsx`, find where `<ScoreSubmission` is rendered and add:
```js
  difficulty={difficulty}
```

Also add `difficulty` to GameReport's props destructuring.

**Step 4: Pass difficulty from GameBoard to GameReport**

In `GameBoard.jsx`, find where `<GameReport` is rendered (~line 346) and add:
```js
  difficulty={difficulty}
```

Also add `difficulty` to GameBoard's props destructuring (~line 46).

**Step 5: Pass difficulty from App.js to GameBoard**

In `App.js`, find the GameBoard render and add to props:
```js
  difficulty={game.difficulty}
```

**Step 6: Build**

Run: `npx react-scripts build`
Expected: Compiled successfully

**Step 7: Commit**

```
git add src/lib/supabase.js src/components/ScoreSubmission.jsx src/components/GameReport.jsx src/components/GameBoard.jsx src/App.js
git commit -m "Wire difficulty through score submission to Supabase"
```

---

### Task 5: Add difficulty to TeacherDashboard display

**Files:**
- Modify: `src/components/TeacherDashboard.jsx` (lines 283-312)

**Step 1: Add Difficulty column header**

After the "Faction" header (~line 286), add:
```jsx
<th className="py-2 font-normal">Difficulty</th>
```

**Step 2: Add Difficulty column data**

After the faction `<td>` (~line 298), add:
```jsx
<td className="py-2 text-parchment-dark/60 capitalize">{s.difficulty || 'medium'}</td>
```

**Step 3: Add Difficulty to CSV export**

Find the CSV headers array (~line 97) and add `'Difficulty'` after `'Faction'`. In the rows mapping (~line 101), add `factionLabels[s.faction] || s.faction,` is followed by:
```js
s.difficulty || 'medium',
```

**Step 4: Build**

Run: `npx react-scripts build`
Expected: Compiled successfully

**Step 5: Commit**

```
git add src/components/TeacherDashboard.jsx
git commit -m "Show difficulty column in Teacher Dashboard"
```

---

## Phase 2: Quiz Gate Data + Component (independent of flow changes)

### Task 6: Create quizGateQuestions.js

**Files:**
- Create: `src/data/quizGateQuestions.js`

**Step 1: Write the quiz data**

```js
/**
 * Pre-game comprehension quiz — 8 questions tied to Learning Mode sections.
 * Students must answer each correctly (retry until correct) before playing.
 */

const quizGateQuestions = [
  {
    id: 'qg1',
    section: 1,
    question: 'What was impressment?',
    simpleQuestion: 'What did "impressment" mean?',
    answers: [
      'Forcing American sailors to serve in the British Navy',
      'A tax Britain placed on American goods',
      'A treaty between Britain and France',
      'A type of naval battle formation',
    ],
    correctIndex: 0,
    explanation: 'Impressment was the British practice of stopping American ships and forcing sailors to serve in the Royal Navy. Britain claimed the right to take anyone they considered a British subject, and thousands of American sailors were taken this way.',
    simpleExplanation: 'Impressment means the British grabbed American sailors from their ships and made them work on British ships. This happened to thousands of Americans and made people very angry.',
  },
  {
    id: 'qg2',
    section: 2,
    question: 'Why was the congressional vote to declare war so close?',
    simpleQuestion: 'Why did so many people in Congress vote against the war?',
    answers: [
      'The country was divided — New England merchants depended on trade with Britain',
      'Most Americans did not know who Britain was',
      'Congress had not yet been formed in 1812',
      'The President vetoed the declaration of war',
    ],
    correctIndex: 0,
    explanation: 'The war vote (79-49 in the House, 19-13 in the Senate) was the closest in American history. New England merchants opposed the war because they profited from trade with Britain, while the South and West supported it.',
    simpleExplanation: 'Many people in New England did not want war because they made money trading with Britain. People in the South and West wanted war because they were angry about impressment and wanted more land.',
  },
  {
    id: 'qg3',
    section: 3,
    question: 'Why was the USS Constitution nicknamed "Old Ironsides"?',
    simpleQuestion: 'Why did people call the USS Constitution "Old Ironsides"?',
    answers: [
      'British cannonballs bounced off its thick oak hull',
      'It was built entirely from iron',
      'Its captain was named Ironsides',
      'It was the oldest ship in the American fleet',
    ],
    correctIndex: 0,
    explanation: 'During its battle with HMS Guerriere, British cannonballs appeared to bounce off the Constitution\'s thick live-oak hull. Sailors shouted "Huzza! Her sides are made of iron!" and the nickname stuck.',
    simpleExplanation: 'When British cannonballs bounced right off the ship\'s thick wooden walls, people started calling it "Old Ironsides" because it seemed like the ship was made of iron.',
  },
  {
    id: 'qg4',
    section: 4,
    question: 'What was Tecumseh trying to build?',
    simpleQuestion: 'What was Tecumseh\'s big plan?',
    answers: [
      'A confederacy of Native tribes to resist American expansion',
      'A new capital city for the United States',
      'A fleet of warships on the Great Lakes',
      'A trade agreement with France',
    ],
    correctIndex: 0,
    explanation: 'Tecumseh, a Shawnee leader, traveled thousands of miles to unite Native tribes into a single confederacy strong enough to stop American settlers from taking their lands. He allied with Britain because they promised to help create an independent Native state.',
    simpleExplanation: 'Tecumseh wanted to bring all the Native tribes together into one big group. Together they would be strong enough to stop Americans from taking their land.',
  },
  {
    id: 'qg5',
    section: 5,
    question: 'Why was the Battle of Lake Erie a turning point in the war?',
    simpleQuestion: 'Why was winning the battle on Lake Erie so important?',
    answers: [
      'American control of the lake cut off British supply lines to Detroit',
      'It was the first time the British surrendered to Americans',
      'The battle destroyed all British ships in North America',
      'It led directly to the signing of the peace treaty',
    ],
    correctIndex: 0,
    explanation: 'Perry\'s victory gave America control of Lake Erie, which cut off British supply routes to Detroit and the entire western frontier. This forced the British to retreat into Canada, where Tecumseh was killed at the Battle of the Thames.',
    simpleExplanation: 'When Perry won on Lake Erie, the British could no longer send food and supplies to their soldiers at Detroit. They had to run away into Canada.',
  },
  {
    id: 'qg6',
    section: 6,
    question: 'What event inspired Francis Scott Key to write "The Star-Spangled Banner"?',
    simpleQuestion: 'What made Francis Scott Key write "The Star-Spangled Banner"?',
    answers: [
      'Watching Fort McHenry survive a night-long British bombardment',
      'Seeing the White House burn down',
      'Watching the Battle of New Orleans',
      'Hearing about the Treaty of Ghent',
    ],
    correctIndex: 0,
    explanation: 'British ships bombarded Fort McHenry in Baltimore Harbor all night. At dawn, Key saw the American flag still flying over the fort — proving the defenders had held. He wrote the poem that became the national anthem.',
    simpleExplanation: 'The British fired bombs at Fort McHenry all night long. In the morning, the American flag was still flying. Francis Scott Key saw this and wrote a poem about it that became our national anthem.',
  },
  {
    id: 'qg7',
    section: 8,
    question: 'What did the Treaty of Ghent actually change?',
    simpleQuestion: 'What changed because of the peace treaty?',
    answers: [
      'Nothing — borders returned to pre-war lines (status quo ante bellum)',
      'Britain gave Canada to the United States',
      'The United States paid Britain for war damages',
      'Native Americans received a protected homeland',
    ],
    correctIndex: 0,
    explanation: 'The Treaty of Ghent restored everything to pre-war conditions — no territory changed hands. "Status quo ante bellum" means "the way things were before the war." Native Americans were the biggest losers — the treaty said nothing about protecting their lands.',
    simpleExplanation: 'The treaty changed nothing on the map. Everything went back to how it was before the war. No one gained any land. The Latin words "status quo ante bellum" mean "back to how things were."',
  },
  {
    id: 'qg8',
    section: 9,
    question: 'How did approximately 4,000 enslaved people seek freedom during the war?',
    simpleQuestion: 'How did about 4,000 enslaved people try to become free during the war?',
    answers: [
      'They escaped to British lines, where they were offered freedom',
      'They signed petitions and sent them to Congress',
      'President Madison freed them by executive order',
      'They moved to Canada before the war started',
    ],
    correctIndex: 0,
    explanation: 'About 4,000 enslaved people escaped to British ships and camps, where they were offered freedom. Some joined the Colonial Marines and fought against their former enslavers. After the war, Britain resettled most in Nova Scotia and Trinidad.',
    simpleExplanation: 'About 4,000 enslaved people ran away to the British side. The British promised them freedom. Some even joined the British army and fought. After the war, Britain helped them start new lives in Canada and the Caribbean.',
  },
];

export default quizGateQuestions;
```

**Step 2: Build**

Run: `npx react-scripts build`
Expected: Compiled successfully

**Step 3: Commit**

```
git add src/data/quizGateQuestions.js
git commit -m "Add 8 pre-game quiz gate questions with Explorer variants"
```

---

### Task 7: Create QuizGate component

**Files:**
- Create: `src/components/QuizGate.jsx`

**Step 1: Write the component**

```jsx
import React, { useState, useCallback } from 'react';
import quizGateQuestions from '../data/quizGateQuestions';

export default function QuizGate({ onComplete, gameMode }) {
  const isExplorer = gameMode === 'explorer';
  const [currentIndex, setCurrentIndex] = useState(0);
  const [selectedAnswer, setSelectedAnswer] = useState(null);
  const [showResult, setShowResult] = useState(false);
  const [isCorrect, setIsCorrect] = useState(false);
  const [completed, setCompleted] = useState(false);

  const question = quizGateQuestions[currentIndex];
  const totalQuestions = quizGateQuestions.length;
  const progress = ((currentIndex + (completed ? 1 : 0)) / totalQuestions) * 100;

  const questionText = isExplorer && question.simpleQuestion
    ? question.simpleQuestion
    : question.question;
  const explanationText = isExplorer && question.simpleExplanation
    ? question.simpleExplanation
    : question.explanation;

  const handleAnswer = useCallback((answerIndex) => {
    if (showResult) return;
    setSelectedAnswer(answerIndex);
    const correct = answerIndex === question.correctIndex;
    setIsCorrect(correct);
    setShowResult(true);

    if (correct) {
      // Auto-advance after a brief delay
      setTimeout(() => {
        if (currentIndex < totalQuestions - 1) {
          setCurrentIndex(prev => prev + 1);
          setSelectedAnswer(null);
          setShowResult(false);
          setIsCorrect(false);
        } else {
          setCompleted(true);
        }
      }, 1500);
    }
  }, [showResult, question.correctIndex, currentIndex, totalQuestions]);

  const handleRetry = useCallback(() => {
    setSelectedAnswer(null);
    setShowResult(false);
    setIsCorrect(false);
  }, []);

  if (completed) {
    return (
      <div className="min-h-screen flex items-center justify-center p-4" style={{ background: 'radial-gradient(ellipse at center, rgba(20,30,48,1) 0%, rgba(10,10,8,1) 100%)' }}>
        <div className="max-w-2xl w-full text-center animate-fadein">
          <div className="bg-war-navy border border-war-gold/30 rounded-lg p-8 md:p-12 shadow-modal">
            <div className="w-16 h-16 rounded-full bg-war-gold/20 border-2 border-war-gold/50 flex items-center justify-center mx-auto mb-6">
              <span className="text-3xl">&#10003;</span>
            </div>
            <h2 className={`font-display text-war-gold tracking-wide mb-4 ${isExplorer ? 'text-3xl md:text-4xl' : 'text-2xl md:text-3xl'}`}>
              Ready for Battle!
            </h2>
            <p className={`text-parchment/70 font-body mb-8 ${isExplorer ? 'text-lg leading-loose' : 'text-base leading-relaxed'}`}>
              {isExplorer
                ? 'Great job! You learned about the War of 1812. Now it is time to pick your side and play!'
                : 'You\'ve demonstrated your knowledge of the War of 1812. Now choose your faction and make history.'}
            </p>
            <button
              onClick={onComplete}
              className="px-8 py-4 bg-war-gold text-war-ink font-display text-lg rounded-lg
                         hover:bg-war-brass transition-colors cursor-pointer font-bold tracking-wider shadow-copper"
            >
              Choose Your Faction
            </button>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen flex items-center justify-center p-4" style={{ background: 'radial-gradient(ellipse at center, rgba(20,30,48,1) 0%, rgba(10,10,8,1) 100%)' }}>
      <div className={isExplorer ? 'max-w-3xl w-full' : 'max-w-2xl w-full'}>
        {/* Header */}
        <div className="text-center mb-6">
          <div className="flex items-center justify-center gap-2 mb-2">
            <div className="w-1.5 h-1.5 rounded-full bg-war-gold/60" />
            <p className="text-war-copper text-xs tracking-[0.2em] uppercase font-body font-bold">Comprehension Check</p>
            <div className="w-1.5 h-1.5 rounded-full bg-war-gold/60" />
          </div>
          <h1 className={`font-display text-war-gold tracking-wide mb-2 ${isExplorer ? 'text-3xl md:text-4xl' : 'text-2xl md:text-3xl'}`}>
            Test Your Knowledge
          </h1>
          <p className={`text-parchment-dark/50 font-body ${isExplorer ? 'text-base' : 'text-sm'}`}>
            Answer each question correctly to unlock the game.
          </p>
        </div>

        {/* Progress Bar */}
        <div className="mb-6">
          <div className="flex justify-between text-xs text-parchment-dark/40 mb-1.5 font-body">
            <span>Question {currentIndex + 1} of {totalQuestions}</span>
            <span>{Math.round(progress)}% Complete</span>
          </div>
          <div className="w-full bg-war-ink rounded-full h-2 border border-parchment-dark/10 overflow-hidden">
            <div
              className="h-full rounded-full transition-all duration-300"
              style={{ width: `${progress}%`, background: 'linear-gradient(to right, #854d0e, #c9a227)' }}
            />
          </div>
        </div>

        {/* Question Card */}
        <div className={`bg-war-navy border border-war-gold/20 rounded-lg shadow-modal animate-fadein ${isExplorer ? 'p-8 md:p-10' : 'p-6 md:p-8'}`}>
          <h2 className={`font-display text-parchment/90 tracking-wide mb-6 ${isExplorer ? 'text-2xl md:text-3xl leading-relaxed' : 'text-xl md:text-2xl'}`}>
            {questionText}
          </h2>

          {/* Answer Choices */}
          <div className="space-y-3 mb-6">
            {question.answers.map((answer, i) => {
              let classes = 'w-full text-left px-5 py-4 rounded-lg border transition-all cursor-pointer font-body';
              if (showResult && i === question.correctIndex) {
                classes += ' border-green-500/50 bg-green-900/20 text-parchment/90';
              } else if (showResult && i === selectedAnswer && !isCorrect) {
                classes += ' border-red-500/50 bg-red-900/20 text-parchment/70';
              } else if (!showResult) {
                classes += ' border-parchment-dark/15 bg-war-navy/50 text-parchment/70 hover:border-war-gold/40 hover:text-parchment/90';
              } else {
                classes += ' border-parchment-dark/10 bg-war-navy/30 text-parchment/50';
              }
              return (
                <button
                  key={i}
                  onClick={() => handleAnswer(i)}
                  disabled={showResult}
                  className={classes}
                  style={showResult ? { cursor: 'default' } : undefined}
                >
                  <span className={`font-display font-bold mr-3 ${isExplorer ? 'text-lg' : 'text-base'}`}>
                    {String.fromCharCode(65 + i)}.
                  </span>
                  <span className={isExplorer ? 'text-lg leading-relaxed' : 'text-base leading-relaxed'}>
                    {answer}
                  </span>
                </button>
              );
            })}
          </div>

          {/* Feedback */}
          {showResult && (
            <div className={`rounded-lg p-4 animate-fadein ${isCorrect ? 'bg-green-900/20 border border-green-500/30' : 'bg-red-900/20 border border-red-500/30'}`}>
              <p className={`font-display font-bold mb-2 ${isCorrect ? 'text-green-400' : 'text-red-400'} ${isExplorer ? 'text-lg' : 'text-base'}`}>
                {isCorrect ? 'Correct!' : 'Not quite — try again!'}
              </p>
              {!isCorrect && (
                <>
                  <p className={`text-parchment/70 font-body mb-4 ${isExplorer ? 'text-base leading-loose' : 'text-sm leading-relaxed'}`}>
                    {explanationText}
                  </p>
                  <button
                    onClick={handleRetry}
                    className="px-6 py-3 bg-war-gold text-war-ink font-display text-sm rounded
                               hover:bg-war-brass transition-colors cursor-pointer font-bold tracking-wide shadow-copper"
                  >
                    Try Again
                  </button>
                </>
              )}
              {isCorrect && (
                <p className={`text-parchment/60 font-body ${isExplorer ? 'text-base' : 'text-sm'}`}>
                  {currentIndex < totalQuestions - 1 ? 'Moving to next question...' : 'All questions complete!'}
                </p>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
```

**Step 2: Build**

Run: `npx react-scripts build`
Expected: Compiled successfully

**Step 3: Commit**

```
git add src/components/QuizGate.jsx
git commit -m "Add QuizGate component with retry-until-correct flow"
```

---

## Phase 3: New Onboarding Step Components

### Task 8: Create NameEntry component

**Files:**
- Create: `src/components/NameEntry.jsx`

**Step 1: Write the component**

This component moves the name/class period inputs and saved game card out of FactionSelect. Reference `src/components/FactionSelect.jsx` lines 188-213 (inputs) and 311-351 (saved game card) for exact current UI patterns.

```jsx
import React, { useState } from 'react';
import LeaderboardPreview from './LeaderboardPreview';

export default function NameEntry({
  onNext,
  savedGame,
  onContinue,
  onDeleteSave,
  onExportSave,
  onImportSave,
  fontMode,
  toggleFont,
}) {
  const [playerName, setPlayerName] = useState('');
  const [classPeriod, setClassPeriod] = useState('');
  const [confirmingDelete, setConfirmingDelete] = useState(false);
  const [showLeaderboard, setShowLeaderboard] = useState(false);
  const [toastMessage, setToastMessage] = useState('');

  const handleContinue = () => {
    if (playerName.trim()) {
      onNext({
        playerName: playerName.trim(),
        classPeriod: classPeriod.trim() || 'Unassigned',
      });
    }
  };

  const handleKeyDown = (e) => {
    if (e.key === 'Enter' && playerName.trim()) {
      handleContinue();
    }
  };

  const handleImport = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    try {
      const text = await file.text();
      onImportSave(text);
      setToastMessage('Save imported!');
      setTimeout(() => setToastMessage(''), 3000);
    } catch {
      setToastMessage('Invalid save file.');
      setTimeout(() => setToastMessage(''), 3000);
    }
    e.target.value = '';
  };

  return (
    <div className="min-h-screen flex items-center justify-center p-4" style={{ background: 'radial-gradient(ellipse at center, rgba(20,30,48,1) 0%, rgba(10,10,8,1) 100%)' }}>
      <div className="max-w-2xl w-full">
        {/* Header */}
        <div className="text-center mb-8">
          <h1 className="text-4xl md:text-5xl font-display text-war-gold tracking-wide mb-3">
            War of 1812
          </h1>
          <p className="text-war-copper text-xs tracking-[0.2em] uppercase font-body font-bold">
            Rise of the Nation
          </p>
        </div>

        {/* Main Card */}
        <div className="bg-war-navy border border-war-gold/20 rounded-lg p-6 md:p-8 shadow-modal animate-fadein">
          <h2 className="text-xl font-display text-war-gold/80 mb-6 tracking-wide border-b border-war-gold/15 pb-3">
            Identify Yourself, Commander
          </h2>

          {/* Name Input */}
          <div className="mb-4">
            <label className="block text-parchment/60 text-xs uppercase tracking-wider mb-1.5 font-body font-bold">
              Commander&apos;s Name <span className="text-war-red/60">*</span>
            </label>
            <input
              type="text"
              value={playerName}
              onChange={(e) => setPlayerName(e.target.value.slice(0, 30))}
              onKeyDown={handleKeyDown}
              placeholder="Enter your name"
              className="w-full bg-war-ink/50 border border-parchment-dark/15 rounded px-4 py-3 text-parchment/90
                         placeholder-parchment-dark/30 font-body focus:border-war-gold/40 focus:outline-none transition-colors"
              autoFocus
            />
          </div>

          {/* Class Period Input */}
          <div className="mb-6">
            <label className="block text-parchment/60 text-xs uppercase tracking-wider mb-1.5 font-body font-bold">
              Class Period <span className="text-parchment-dark/30">(optional)</span>
            </label>
            <input
              type="text"
              value={classPeriod}
              onChange={(e) => setClassPeriod(e.target.value.slice(0, 10))}
              onKeyDown={handleKeyDown}
              placeholder="e.g., Period 3"
              className="w-full bg-war-ink/50 border border-parchment-dark/15 rounded px-4 py-3 text-parchment/90
                         placeholder-parchment-dark/30 font-body focus:border-war-gold/40 focus:outline-none transition-colors"
            />
          </div>

          {/* Continue Button */}
          <button
            onClick={handleContinue}
            disabled={!playerName.trim()}
            className={`w-full py-4 font-display text-lg rounded-lg font-bold tracking-wider transition-colors
                       shadow-copper ${playerName.trim()
                         ? 'bg-war-gold text-war-ink hover:bg-war-brass cursor-pointer'
                         : 'bg-parchment-dark/20 text-parchment-dark/40 cursor-not-allowed'}`}
          >
            Continue
          </button>
        </div>

        {/* Saved Game Card */}
        {savedGame && (
          <div className="mt-6 bg-war-navy border border-war-gold/20 rounded-lg p-5 shadow-modal animate-fadein">
            <div className="flex items-center justify-between mb-3">
              <h3 className="text-war-gold/80 font-display text-sm tracking-wide">Saved Campaign</h3>
              <span className="text-parchment-dark/40 text-xs font-body">{savedGame.timestamp ? new Date(savedGame.timestamp).toLocaleDateString() : ''}</span>
            </div>
            <p className="text-parchment/70 text-sm font-body mb-3">
              {savedGame.playerName} &mdash; {savedGame.faction === 'us' ? 'United States' : savedGame.faction === 'british' ? 'British/Canada' : 'Native Coalition'} &mdash; Round {savedGame.round}, {savedGame.season}
            </p>
            <div className="flex flex-wrap gap-2">
              <button
                onClick={onContinue}
                className="px-4 py-2 bg-war-gold text-war-ink font-display text-xs rounded font-bold
                           hover:bg-war-brass transition-colors cursor-pointer tracking-wide"
              >
                Continue Campaign
              </button>
              {confirmingDelete ? (
                <div className="flex gap-1">
                  <button onClick={() => { onDeleteSave(); setConfirmingDelete(false); }}
                    className="px-3 py-2 bg-war-red/80 text-parchment font-display text-xs rounded font-bold
                               hover:bg-war-red transition-colors cursor-pointer tracking-wide">
                    Confirm Delete
                  </button>
                  <button onClick={() => setConfirmingDelete(false)}
                    className="px-3 py-2 border border-parchment-dark/20 text-parchment-dark/60 font-display text-xs rounded
                               hover:border-war-gold/40 transition-colors cursor-pointer">
                    Cancel
                  </button>
                </div>
              ) : (
                <button onClick={() => setConfirmingDelete(true)}
                  className="px-3 py-2 border border-parchment-dark/20 text-parchment-dark/60 font-display text-xs rounded
                             hover:border-war-red/40 hover:text-war-red/80 transition-colors cursor-pointer tracking-wide">
                  Delete
                </button>
              )}
              <button onClick={onExportSave}
                className="px-3 py-2 border border-parchment-dark/20 text-parchment-dark/60 font-display text-xs rounded
                           hover:border-war-gold/40 hover:text-parchment transition-colors cursor-pointer tracking-wide">
                Export
              </button>
              <label className="px-3 py-2 border border-parchment-dark/20 text-parchment-dark/60 font-display text-xs rounded
                           hover:border-war-gold/40 hover:text-parchment transition-colors cursor-pointer tracking-wide">
                Import
                <input type="file" accept=".json" onChange={handleImport} className="hidden" />
              </label>
            </div>
          </div>
        )}

        {/* Toast */}
        {toastMessage && (
          <div className="mt-4 text-center text-parchment/70 text-sm font-body animate-fadein">{toastMessage}</div>
        )}

        {/* Leaderboard Preview */}
        <div className="mt-6">
          <LeaderboardPreview onViewFull={() => setShowLeaderboard(true)} />
        </div>

        {/* Font Toggle */}
        <div className="mt-6 text-center">
          <button
            onClick={toggleFont}
            className="text-parchment-dark/40 text-xs font-body hover:text-parchment/60 transition-colors cursor-pointer"
          >
            {fontMode === 'dyslexic' ? 'Switch to Standard Font' : 'Switch to OpenDyslexic Font'}
          </button>
        </div>

        {showLeaderboard && (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm"
               onClick={() => setShowLeaderboard(false)}>
            <div className="bg-war-navy border border-war-gold/30 rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto shadow-modal"
                 onClick={(e) => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-war-gold font-display text-xl tracking-wide">Leaderboard</h2>
                <button onClick={() => setShowLeaderboard(false)}
                  className="text-parchment-dark/40 hover:text-parchment/70 transition-colors cursor-pointer text-xl">&times;</button>
              </div>
              <LeaderboardPreview fullMode />
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
```

**Step 2: Build**

Run: `npx react-scripts build`
Expected: Compiled successfully

**Step 3: Commit**

```
git add src/components/NameEntry.jsx
git commit -m "Add NameEntry onboarding step component"
```

---

### Task 9: Create DifficultySelect component

**Files:**
- Create: `src/components/DifficultySelect.jsx`

**Step 1: Write the component**

```jsx
import React, { useState } from 'react';
import { DIFFICULTY_LABELS } from '../data/difficultySettings';

const difficulties = ['easy', 'medium', 'hard'];

const difficultyColors = {
  easy: { border: 'border-green-500/30', bg: 'bg-green-900/10', accent: 'text-green-400' },
  medium: { border: 'border-war-gold/30', bg: 'bg-war-gold/10', accent: 'text-war-gold' },
  hard: { border: 'border-red-500/30', bg: 'bg-red-900/10', accent: 'text-red-400' },
};

export default function DifficultySelect({ onNext, playerName }) {
  const [difficulty, setDifficulty] = useState('medium');
  const [gameMode, setGameMode] = useState('historian');

  const handleContinue = () => {
    onNext({ difficulty, gameMode });
  };

  return (
    <div className="min-h-screen flex items-center justify-center p-4" style={{ background: 'radial-gradient(ellipse at center, rgba(20,30,48,1) 0%, rgba(10,10,8,1) 100%)' }}>
      <div className="max-w-3xl w-full">
        {/* Header */}
        <div className="text-center mb-8">
          <p className="text-war-copper text-xs tracking-[0.2em] uppercase font-body font-bold mb-2">
            Welcome, {playerName}
          </p>
          <h1 className="text-3xl md:text-4xl font-display text-war-gold tracking-wide mb-2">
            Choose Your Challenge
          </h1>
          <p className="text-parchment-dark/50 text-sm font-body">
            Select how tough you want the AI opponent to be.
          </p>
        </div>

        {/* Difficulty Cards */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
          {difficulties.map((d) => {
            const label = DIFFICULTY_LABELS[d];
            const colors = difficultyColors[d];
            const selected = difficulty === d;
            return (
              <button
                key={d}
                onClick={() => setDifficulty(d)}
                className={`p-6 rounded-lg border-2 transition-all cursor-pointer text-left
                  ${selected
                    ? `${colors.border} ${colors.bg} shadow-modal`
                    : 'border-parchment-dark/10 bg-war-navy/50 hover:border-parchment-dark/25'
                  }`}
              >
                <h3 className={`font-display text-xl mb-2 tracking-wide ${selected ? colors.accent : 'text-parchment/70'}`}>
                  {label.name}
                </h3>
                <p className={`text-sm font-body leading-relaxed ${selected ? 'text-parchment/70' : 'text-parchment-dark/50'}`}>
                  {label.description}
                </p>
                {d === 'medium' && (
                  <span className="inline-block mt-3 text-xs font-body text-war-gold/50 uppercase tracking-wider">
                    Recommended
                  </span>
                )}
              </button>
            );
          })}
        </div>

        {/* Explorer/Historian Toggle */}
        <div className="bg-war-navy border border-war-gold/20 rounded-lg p-6 shadow-modal mb-8">
          <h2 className="text-war-gold/80 font-display text-sm mb-4 tracking-wide border-b border-war-gold/15 pb-2">
            Reading Level
          </h2>
          <div className="flex gap-3">
            <button
              onClick={() => setGameMode('historian')}
              className={`flex-1 py-3 px-4 rounded-lg font-display text-sm tracking-wide transition-all cursor-pointer border
                ${gameMode === 'historian'
                  ? 'bg-war-gold/15 border-war-gold/40 text-war-gold font-bold'
                  : 'border-parchment-dark/15 text-parchment-dark/50 hover:border-parchment-dark/30'
                }`}
            >
              <span className="block text-base mb-1">Historian Mode</span>
              <span className="block text-xs font-body font-normal opacity-70">Full detail &mdash; 8th grade reading level</span>
            </button>
            <button
              onClick={() => setGameMode('explorer')}
              className={`flex-1 py-3 px-4 rounded-lg font-display text-sm tracking-wide transition-all cursor-pointer border
                ${gameMode === 'explorer'
                  ? 'bg-war-gold/15 border-war-gold/40 text-war-gold font-bold'
                  : 'border-parchment-dark/15 text-parchment-dark/50 hover:border-parchment-dark/30'
                }`}
            >
              <span className="block text-base mb-1">Explorer Mode</span>
              <span className="block text-xs font-body font-normal opacity-70">Simplified text &mdash; 3rd grade reading level</span>
            </button>
          </div>
        </div>

        {/* Continue Button */}
        <button
          onClick={handleContinue}
          className="w-full py-4 bg-war-gold text-war-ink font-display text-lg rounded-lg font-bold tracking-wider
                     hover:bg-war-brass transition-colors cursor-pointer shadow-copper"
        >
          Continue
        </button>
      </div>
    </div>
  );
}
```

**Step 2: Build**

Run: `npx react-scripts build`
Expected: Compiled successfully

**Step 3: Commit**

```
git add src/components/DifficultySelect.jsx
git commit -m "Add DifficultySelect onboarding step component"
```

---

## Phase 4: App.js Routing + FactionSelect Modifications

### Task 10: Rewrite App.js onboarding routing

**Files:**
- Modify: `src/App.js`

This is the biggest single change. The key modifications:

**Step 1: Update imports**

Add new imports at the top:
```js
import NameEntry from './components/NameEntry';
import DifficultySelect from './components/DifficultySelect';
import QuizGate from './components/QuizGate';
```

**Step 2: Replace state variables**

Remove:
```js
const [showLearningMode, setShowLearningMode] = useState(false);
const [learningCompleted, setLearningCompleted] = useState(false);
```

Add:
```js
const [onboardingStep, setOnboardingStep] = useState('name');
const [onboardingData, setOnboardingData] = useState({
  playerName: '',
  classPeriod: '',
  difficulty: 'medium',
  gameMode: 'historian',
});
```

**Step 3: Add skip parameter check**

After the state declarations, add:
```js
const skipLearning = new URLSearchParams(window.location.search).get('skip') === 'learning';
```

**Step 4: Add step handler callbacks**

Add these callbacks (before the rendering logic):

```js
const handleNameNext = useCallback(({ playerName, classPeriod }) => {
  setOnboardingData(prev => ({ ...prev, playerName, classPeriod }));
  setOnboardingStep('difficulty');
}, []);

const handleDifficultyNext = useCallback(({ difficulty, gameMode }) => {
  setOnboardingData(prev => ({ ...prev, difficulty, gameMode }));
  setOnboardingStep(skipLearning ? 'faction' : 'learning');
}, [skipLearning]);

const handleLearningComplete = useCallback(() => {
  setOnboardingStep('quiz');
}, []);

const handleQuizComplete = useCallback(() => {
  setOnboardingStep('faction');
}, []);

const handleFactionSelect = useCallback((faction) => {
  game.startGame({
    faction,
    playerName: onboardingData.playerName,
    classPeriod: onboardingData.classPeriod,
    gameMode: onboardingData.gameMode,
    difficulty: onboardingData.difficulty,
  });
}, [game, onboardingData]);
```

**Step 5: Update resetGame handler**

Update the existing resetGame/onPlayAgain handler to also reset onboarding:
```js
const handlePlayAgain = useCallback(() => {
  game.resetGame();
  setOnboardingStep('name');
  setOnboardingData({ playerName: '', classPeriod: '', difficulty: 'medium', gameMode: 'historian' });
}, [game]);
```

Pass `handlePlayAgain` instead of `game.resetGame` to GameBoard's `onPlayAgain` prop.

**Step 6: Rewrite the rendering conditions**

Replace the old FactionSelect/LearningMode rendering with the new step-based routing. The `!game.gameStarted && !game.gameOver` block should be replaced with:

```jsx
{/* Onboarding Steps */}
{onboardingStep === 'name' && (
  <NameEntry
    onNext={handleNameNext}
    savedGame={game.hasSavedGame()}
    onContinue={game.loadGame}
    onDeleteSave={game.deleteSave}
    onExportSave={game.exportSaveFile}
    onImportSave={game.importSaveFile}
    fontMode={fontMode}
    toggleFont={toggleFont}
  />
)}
{onboardingStep === 'difficulty' && (
  <DifficultySelect
    onNext={handleDifficultyNext}
    playerName={onboardingData.playerName}
  />
)}
{onboardingStep === 'learning' && (
  <LearningMode
    onComplete={handleLearningComplete}
    gameMode={onboardingData.gameMode}
  />
)}
{onboardingStep === 'quiz' && (
  <QuizGate
    onComplete={handleQuizComplete}
    gameMode={onboardingData.gameMode}
  />
)}
{onboardingStep === 'faction' && (
  <FactionSelect
    onSelect={handleFactionSelect}
    onOpenPeopleGallery={() => setShowPeopleGallery(true)}
    gameMode={onboardingData.gameMode}
    fontMode={fontMode}
    toggleFont={toggleFont}
  />
)}
```

Note: The condition that gates this entire block is `!game.gameStarted && !game.gameOver` — same as before, but now renders different components based on `onboardingStep`.

**Step 7: Remove old LearningMode rendering**

Delete the `showLearningMode && !learningCompleted` conditional block and the `onStartLearning` callback.

**Step 8: Build and test**

Run: `npx react-scripts build`
Expected: Compiled successfully (may have warnings about unused FactionSelect props until Task 11)

Run: `npx react-scripts test --watchAll=false`
Expected: All tests pass

**Step 9: Commit**

```
git add src/App.js
git commit -m "Rewrite App.js with 5-step onboarding routing"
```

---

### Task 11: Strip down FactionSelect

**Files:**
- Modify: `src/components/FactionSelect.jsx`

**Step 1: Update props**

Change the props to only accept what's needed:
```js
export default function FactionSelect({ onSelect, onOpenPeopleGallery, gameMode, fontMode, toggleFont })
```

**Step 2: Remove local state that moved to other components**

Remove: `playerName`, `classPeriod`, `confirmingDelete`, `toastMessage`, `showLeaderboard`, `gameMode` (now a prop).

Keep: `hoveredFaction`, `selectedFaction`, `showChangelog`.

**Step 3: Update handleStart**

```js
const handleStart = () => {
  if (selectedFaction) {
    onSelect(selectedFaction);
  }
};
```

Note: `onSelect` now just receives the faction string, not an object — App.js handles assembling the full data.

**Step 4: Remove UI sections**

Remove from the JSX:
- Name/class period inputs (Task 8 has these now)
- Explorer/Historian toggle (Task 9 has this now)
- LeaderboardPreview (Task 8 has this now)
- Saved game card (Task 8 has this now)
- "Learn About the War" button (learning is mandatory now)
- Full leaderboard modal (Task 8 has this now)

**Step 5: Add simplified faction descriptions for Explorer mode**

The `isExplorer` variable should use the `gameMode` prop:
```js
const isExplorer = gameMode === 'explorer';
```

Add `simpleDescription` to each faction in the `factions` array and conditionally render.

**Step 6: Keep intact**

- Faction cards (3 cards with selection)
- "March to War" button (now enabled when faction is selected, no name check needed)
- People Gallery button
- Changelog/version/What's New footer
- Font toggle

**Step 7: Disable button only on no faction selected**

```jsx
disabled={!selectedFaction}
```

(Previously it checked `!selectedFaction || !playerName.trim()`)

**Step 8: Build and test**

Run: `npx react-scripts build`
Expected: Compiled successfully, 0 warnings

Run: `npx react-scripts test --watchAll=false`
Expected: All tests pass

**Step 9: Commit**

```
git add src/components/FactionSelect.jsx
git commit -m "Strip FactionSelect to faction-only selection screen"
```

---

### Task 12: Update LearningMode skip behavior

**Files:**
- Modify: `src/components/LearningMode.jsx`

**Step 1: Remove the onSkip prop**

Update the function signature to no longer accept `onSkip`:
```js
export default function LearningMode({ onComplete, gameMode })
```

**Step 2: Remove the skip button JSX**

Remove the skip button block (the `currentStep === 0 && (...)` block that renders the "Skip (Already learned this)" button).

**Step 3: Build**

Run: `npx react-scripts build`
Expected: Compiled successfully

**Step 4: Commit**

```
git add src/components/LearningMode.jsx
git commit -m "Remove skip button from LearningMode (now teacher-controlled)"
```

---

## Phase 5: Version Bump, Final Verification

### Task 13: Update changelog, README, version

**Files:**
- Modify: `src/data/changelog.js`
- Modify: `README.md`

**Step 1: Update changelog.js**

Change `CURRENT_VERSION` to `'1.5.0'`.

Add new entry at top of changelog array:
```js
{
  version: '1.5.0',
  date: '2026-02-24',
  title: 'Onboarding Redesign & AI Difficulty',
  changes: [
    'New guided onboarding flow: Name → Difficulty → Learning → Quiz → Faction',
    'AI difficulty levels: Learning (Easy), Balanced (Medium), Commander (Hard)',
    'Pre-game quiz gate with 8 comprehension questions (retry until correct)',
    'Explorer/Historian mode moved to difficulty selection screen',
    'Teacher-controlled learning skip via ?skip=learning URL parameter',
    'Difficulty tracked in Supabase and shown on Teacher Dashboard',
  ],
},
```

**Step 2: Update README.md**

- Update version number in header to 1.5.0
- Add v1.5.0 section under "Latest Features"
- Add version history table row
- Update "Current Status" line

**Step 3: Build and run all tests**

Run: `npx react-scripts build`
Expected: Compiled successfully, 0 warnings

Run: `npx react-scripts test --watchAll=false`
Expected: All tests pass (105 tests, 9 suites)

**Step 4: Commit**

```
git add src/data/changelog.js README.md
git commit -m "Bump version to 1.5.0 with changelog and README updates"
```

---

## Summary

| Phase | Tasks | Description |
|-------|-------|-------------|
| 1 | Tasks 1-5 | AI difficulty data layer (no UI changes, zero risk) |
| 2 | Tasks 6-7 | Quiz gate data + component (standalone, no flow changes) |
| 3 | Tasks 8-9 | New step components (standalone, not wired in yet) |
| 4 | Tasks 10-12 | App.js routing rewrite + FactionSelect strip-down + LearningMode skip removal |
| 5 | Task 13 | Version bump, changelog, README |

Each phase is independently committable. Phases 1-3 can be done in any order. Phase 4 depends on all prior phases. Phase 5 is last.

Total: ~13 tasks, ~13 commits.
