# v1.5.0 Design: Onboarding Flow Redesign + AI Difficulty

## Supabase Schema Change (DO THIS FIRST)

```sql
ALTER TABLE scores ADD COLUMN difficulty text DEFAULT 'medium';
```

That's it — one nullable text column. Existing rows will show `'medium'` by default.

---

## Overview

Replace the single FactionSelect screen with a guided 5-step onboarding flow. Add AI difficulty levels (Easy/Medium/Hard). Add a quiz gate between Learning Mode and Faction Select that requires students to demonstrate comprehension before playing.

### New Flow

```
NameEntry → DifficultySelect → LearningMode → QuizGate → FactionSelect → Game
```

### Current Flow (being replaced)

```
FactionSelect (all-in-one) → optional LearningMode → Game
```

---

## Step 1: NameEntry

**New file: `src/components/NameEntry.jsx`**

- Player name input (required, max 30 chars)
- Class period input (optional, max 10 chars, defaults to "Unassigned")
- "Continue" button (disabled until name entered)
- Saved game card (if exists) with Continue/Delete/Export/Import buttons — moved from FactionSelect
- LeaderboardPreview at the bottom — moved from FactionSelect
- War Room Cartography theme (same design tokens)

---

## Step 2: DifficultySelect

**New file: `src/components/DifficultySelect.jsx`**

Three difficulty cards:

| Level | Label | Description |
|-------|-------|-------------|
| Easy | "Learning" | The AI takes it easy. Good for learning the game. |
| Medium | "Balanced" (default, highlighted) | A fair challenge. The AI plays smart. |
| Hard | "Commander" | The AI is aggressive and relentless. For experienced players. |

Plus Explorer/Historian mode toggle below the cards (same toggle UI as current FactionSelect). This choice affects all text in subsequent steps (Learning Mode, Quiz Gate, Faction Select, IntroScreen, Tutorial, in-game).

"Continue" button.

---

## Step 3: LearningMode (modified)

**File: `src/components/LearningMode.jsx`**

- Remove `onSkip` prop — no skip button by default
- Skip only available if `?skip=learning` URL parameter is present (teacher-controlled)
- Receives `gameMode` from onboarding data (set in DifficultySelect)
- All v1.4.1 improvements apply (bold rendering, inline vocab, Key Idea, etc.)

---

## Step 4: QuizGate

**New file: `src/components/QuizGate.jsx`**

8 comprehension questions presented one at a time:
- Shows question + 4 multiple choice answers
- Wrong answer → shows explanation + "Try Again" button (same question loops until correct)
- Correct answer → brief "Correct!" feedback → auto-advances to next question after short delay
- Progress bar: "Question 3 of 8"
- On completion → congratulations message + "Choose Your Faction" button
- Explorer mode shows `simpleQuestion` / `simpleExplanation` variants

**New file: `src/data/quizGateQuestions.js`**

8 questions covering key concepts from Learning Mode:

1. Causes — What was impressment? (Section 1)
2. Declaration — Why was the war vote so close? (Section 2)
3. Early Battles — Why was the USS Constitution nicknamed "Old Ironsides"? (Section 3)
4. Native Involvement — What was Tecumseh trying to build? (Section 4)
5. Turning Points — Why was the Battle of Lake Erie so important? (Section 5)
6. British Offensive — What inspired "The Star-Spangled Banner"? (Section 6)
7. Treaty & Legacy — What did "status quo ante bellum" mean? (Section 8)
8. Diverse Experiences — How did enslaved people use the war to seek freedom? (Section 9)

Each question has: `question`, `simpleQuestion`, `answers` (4 choices), `correctIndex`, `explanation`, `simpleExplanation`.

---

## Step 5: FactionSelect (modified)

**File: `src/components/FactionSelect.jsx`**

Stripped down — removes:
- Name/class period inputs (moved to NameEntry)
- Explorer/Historian toggle (moved to DifficultySelect)
- LeaderboardPreview (moved to NameEntry)
- Saved game card (moved to NameEntry)
- "Learn About the War" button (learning is now a required step)

Keeps:
- Three faction cards with descriptions, leaders, bonuses
- "March to War" button
- People Gallery button
- Changelog/version footer
- Font toggle

Accepts `gameMode` prop to show simplified faction descriptions in Explorer mode.

---

## AI Difficulty System

**New file: `src/data/difficultySettings.js`**

Three config profiles that override specific `AI_CONFIG` values:

| Parameter | Easy | Medium (current) | Hard |
|-----------|------|--------|------|
| BASE_REINFORCEMENTS | 2 | 4 | 6 |
| MAX_ATTACKS_PER_TURN | 2 | 5 | 7 |
| MIN_ATTACK_PROBABILITY | 0.55 | 0.3 | 0.15 |
| CONCENTRATION_RATIO | 0.2 | 0.4 | 0.6 |
| TOP_N_ATTACK_CHOICES | 5 | 3 | 1 |
| ATTACK_PROBABILITY_WEIGHT | 8 | 5 | 2 |
| ATTACK_FORT_PENALTY | 5 | 3 | 1 |
| MAX_TROOPS_TO_MOVE | 1 | 3 | 5 |
| MAX_MANEUVERS | 1 | 3 | 5 |

All other `AI_CONFIG` values remain unchanged across difficulties.

**Medium is identical to current behavior** — existing gameplay preserved as baseline.

### Integration

- `useAI.js`: Accept `difficulty` param. Merge difficulty overrides into `AI_CONFIG` at the start of `runAITurn`.
- `gameReducer.js`: Add `difficulty` to initial state (`'medium'`), set in `GAME_START`, restore in `LOAD_GAME_STATE` (default `'medium'` for old saves).
- `useGameStateV2.js`: Pass `difficulty` through `startGame`. Expose in return value. Pass to `useAI`.

---

## App.js Routing Changes

### New State

```js
const [onboardingStep, setOnboardingStep] = useState('name');
const [onboardingData, setOnboardingData] = useState({
  playerName: '',
  classPeriod: '',
  difficulty: 'medium',
  gameMode: 'historian',
});
```

### Removed State

```js
// showLearningMode — replaced by onboardingStep === 'learning'
// learningCompleted — replaced by onboardingStep advancing past 'quiz'
```

### Routing Priority

```
route === '#teacher'                    → TeacherDashboard
route === '#guide'                      → TeacherGuide
showPeopleGallery                       → PeopleGallery
game.gameStarted || game.gameOver       → GameBoard
onboardingStep === 'name'               → NameEntry
onboardingStep === 'difficulty'         → DifficultySelect
onboardingStep === 'learning'           → LearningMode
onboardingStep === 'quiz'               → QuizGate
onboardingStep === 'faction'            → FactionSelect
```

### Step Transitions

```
NameEntry        → onNext({ playerName, classPeriod })    → 'difficulty'
DifficultySelect → onNext({ difficulty, gameMode })       → 'learning'
                                                            (or 'faction' if ?skip=learning)
LearningMode     → onComplete()                           → 'quiz'
QuizGate         → onComplete()                           → 'faction'
FactionSelect    → onSelect({ faction })                  → startGame(allData)
```

### Teacher Skip Parameter

`?skip=learning` in the URL skips both Learning Mode and Quiz Gate steps (difficulty → faction directly). Checked via `new URLSearchParams(window.location.search).get('skip') === 'learning'`.

### Game Reset

When `resetGame()` is called (Play Again), `onboardingStep` resets to `'name'` and `onboardingData` clears.

---

## Supabase Changes

### Schema

```sql
ALTER TABLE scores ADD COLUMN difficulty text DEFAULT 'medium';
```

### submitScore

`src/lib/supabase.js` — add `difficulty` field to the insert payload.

### Teacher Dashboard

Display difficulty column in score tables. Optional: filter by difficulty.

---

## Save/Load Compatibility

- `difficulty` added to save file structure
- `LOAD_GAME_STATE` restores `difficulty` with default `'medium'` for old saves
- Old saves without `difficulty` field work exactly as before (medium AI behavior)

---

## Files Summary

### New Files (5)

| File | Purpose |
|------|---------|
| `src/components/NameEntry.jsx` | Step 1: name + class period + saved game + leaderboard |
| `src/components/DifficultySelect.jsx` | Step 2: Easy/Medium/Hard + Explorer/Historian |
| `src/components/QuizGate.jsx` | Step 4: 8 comprehension questions, retry-until-correct |
| `src/data/quizGateQuestions.js` | Quiz gate question data (standard + Explorer variants) |
| `src/data/difficultySettings.js` | AI config overrides for Easy/Medium/Hard |

### Modified Files (~8)

| File | Changes |
|------|---------|
| `src/App.js` | New onboarding step routing, remove showLearningMode/learningCompleted, add ?skip=learning check |
| `src/components/FactionSelect.jsx` | Strip name/period/mode/leaderboard/save, accept gameMode prop |
| `src/components/LearningMode.jsx` | Remove onSkip, conditional skip via URL param |
| `src/hooks/useAI.js` | Accept difficulty, merge config overrides |
| `src/reducers/gameReducer.js` | Add difficulty to state, GAME_START, LOAD_GAME_STATE |
| `src/hooks/useGameStateV2.js` | Pass difficulty through startGame, expose in return, pass to useAI |
| `src/lib/supabase.js` | Add difficulty to submitScore |
| `src/data/changelog.js` | Version 1.5.0 + changelog entry |

Plus `README.md` update.

---

## Verification Checklist

1. `npx react-scripts build` — 0 warnings
2. `npx react-scripts test --watchAll=false` — all tests pass
3. Manual checks:
   - Full flow: name → difficulty → learning → quiz → faction → game
   - Skip flow: name → difficulty → faction → game (with ?skip=learning)
   - Saved game continue from NameEntry screen
   - Explorer mode text flows through all steps correctly
   - Easy AI is noticeably passive, Hard AI is noticeably aggressive
   - Medium AI plays identically to current v1.4.1 behavior
   - Score submission includes difficulty field
   - Old saves load correctly (default to medium)
   - Quiz gate: wrong answers show explanation and retry, correct answers advance
   - People Gallery accessible from FactionSelect
   - Font toggle works on FactionSelect
   - Teacher Dashboard shows difficulty column
