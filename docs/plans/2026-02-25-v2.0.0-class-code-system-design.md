# v2.0.0 Design: Class Code System

**Date:** 2026-02-25
**Status:** Approved

## Goal

Replace the shared-password Teacher Dashboard with real Supabase Auth so each teacher has an isolated view of only their students' data. Teachers create classes with shareable codes/links; students enter a code during onboarding to connect their game data to a teacher.

## Decisions

- **Auth provider:** Supabase Auth (already in stack, @supabase/supabase-js ^2.97.0)
- **Auth method:** Magic link (primary) + email/password (fallback)
- **Teacher sign-up:** Open (anyone with email)
- **One account per teacher**, unlimited classes
- **Class code replaces period field** for students who enter one; standalone play still works without a code
- **Teacher dashboards fully isolated** — each teacher sees only their classes' data
- **Global leaderboard unchanged** — all students appear regardless of class association
- **No archive/delete** for classes (keep simple for pilot)
- **Late join:** Students without a class_id get prompted at score submission to enter a code, which retroactively links their quiz gate data via session_id

## Database Schema

### New table: `teachers`

| Column | Type | Purpose |
|--------|------|---------|
| `id` | uuid (PK, FK → auth.users.id) | Matches Supabase auth user ID |
| `display_name` | text | Teacher name shown on dashboard |
| `email` | text | For display |
| `created_at` | timestamptz | Auto, default now() |

### New table: `classes`

| Column | Type | Purpose |
|--------|------|---------|
| `id` | uuid (PK, default gen_random_uuid()) | Class ID |
| `teacher_id` | uuid (FK → teachers.id) | Who owns this class |
| `name` | text | e.g., "3rd Period", "Block A" |
| `code` | text (unique) | 6-char alphanumeric code students enter |
| `created_at` | timestamptz | Auto, default now() |

### Alter table: `scores`

Add `class_id` uuid (nullable, FK → classes.id). Null = standalone student.

### Alter table: `quiz_gate_results`

Add `class_id` uuid (nullable, FK → classes.id). Null = standalone student.

### RLS Policies

**`teachers`:**
- Authenticated users can INSERT their own row (id = auth.uid())
- Authenticated users can SELECT/UPDATE their own row (id = auth.uid())

**`classes`:**
- Authenticated users can INSERT where teacher_id = auth.uid()
- Authenticated users can SELECT/UPDATE/DELETE where teacher_id = auth.uid()
- Anon can SELECT by code (for student code validation)

**`scores`:**
- Anon can INSERT (unchanged — students submit without auth)
- Anon can SELECT (unchanged — global leaderboard)
- Authenticated can SELECT where class_id in (teacher's classes)
- Anon can UPDATE class_id where session_id matches (for late join)

**`quiz_gate_results`:**
- Anon can INSERT (unchanged)
- Authenticated can SELECT where class_id in (teacher's classes)
- Anon can UPDATE class_id where session_id matches (for late join)

## Auth Flow

### Teacher Sign-Up / Sign-In (at `#teacher`)

1. Default: Email input + "Send Magic Link" button
2. Alternative: "Use password instead" toggle → email + password + Sign In / Sign Up tabs
3. Magic link: Teacher enters email → Supabase sends link → clicks → redirected to `#teacher` → logged in
4. Password: Standard email/password sign in or sign up
5. First login: If no `teachers` row, prompt for display name → create row
6. Session persistence: Supabase SDK manages JWT in localStorage
7. Sign out button in dashboard header

### Supabase Dashboard Config

- Enable Email auth provider
- Set Site URL to `https://1812.mrbsocialstudies.org`
- Add `https://1812.mrbsocialstudies.org#teacher` to Redirect URLs

## Student Experience

### Onboarding (NameEntry screen)

1. **Name** (required, same as now)
2. **Class Code** (optional, replaces Period field)
   - If entered: validate against `classes` table → auto-fill period from class name, store class_id
   - If invalid: inline error "Code not found — check with your teacher"
   - If blank: standalone mode, period field appears as fallback
3. URL-based: `?class=ABC123` param auto-fills the code field

### Late Join (ScoreSubmission screen)

If student has no `class_id` at score submission:
- Show optional "Join a class?" field with code input
- If valid code entered: attach class_id to score AND retroactively update quiz_gate_results via session_id

## Teacher Dashboard

### Replaces shared-password dashboard entirely

**Header:** "Welcome, [display_name]" + Sign Out button

**Classes section (new, top):**
- List of teacher's classes: name, code, student count, copyable join link
- "Create Class" button → modal with name input → generates random 6-char code
- Each class shows "Copy Link" for `https://1812.mrbsocialstudies.org?class=CODE`

**Existing sections (scoped to teacher's classes):**
- Summary cards (total games, avg score, avg quiz %, number of classes)
- Class Breakdown (replaces period breakdown — one row per class)
- Faction Distribution (scoped)
- Quiz Gate Analytics (scoped)
- All Scores (scoped, filterable by class)
- Both CSV exports (scoped)

**Game Guide:** unchanged (static content)

**Standalone students:** Never visible to teachers. Global leaderboard still shows everyone.

## Files Modified

| File | Change |
|------|--------|
| `docs/migrations/002_class_code_system.sql` | New tables, altered tables, RLS policies, grants |
| `src/lib/supabase.js` | Auth functions, class CRUD, class_id in submits, scoped fetches, retroactive linking |
| `src/App.js` | Read ?class= param, store classId in onboarding data, thread props |
| `src/components/NameEntry.jsx` | Replace period with class code field, validation, fallback to period |
| `src/components/ScoreSubmission.jsx` | Optional "Join a class?" code field, retroactive linking |
| `src/components/TeacherDashboard.jsx` | Full rewrite: Supabase Auth, class management, scoped queries |
| `src/components/GameBoard.jsx` | Thread classId prop |
| `src/components/GameReport.jsx` | Thread classId prop |
| `src/hooks/useGameStateV2.js` | Store classId in game state |
| `src/reducers/gameReducer.js` | classId in GAME_START and LOAD_GAME_STATE |
| `src/data/changelog.js` | Bump to 2.0.0 |
| `README.md` | Version, features, updated URLs |
| `docs/TEACHER_QUICK_START.md` | Rewrite for new auth + class code workflow |
| `src/data/teacherGuide.js` | Update references to old password/dashboard |
| `src/components/TeacherGuide.jsx` | Update if it references old password flow |

## No Changes To

- Game logic, combat, events, AI, reducers (beyond classId storage)
- LearningMode, QuizGate, Map, territories, leaders
- Knowledge checks, event cards, people profiles
- Any data files (beyond changelog)
- Global leaderboard behavior

## Risks & Mitigations

1. **Supabase Auth email delivery** — Magic links may be blocked by school email filters → password fallback available
2. **Migration is manual** — SQL must be run in Supabase dashboard before deploying code
3. **Existing data has no class_id** — All existing scores/quiz_gate_results stay with null class_id (standalone). Teachers only see new data from students who use their codes.
4. **RLS complexity** — More policies than before; test thoroughly in Supabase dashboard before deploying
5. **Late join retroactive update** — Uses session_id to link; if student clears localStorage between quiz and score submission, session_id changes and quiz data won't retroactively link (acceptable edge case)
