# Quiz Gate Analytics Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Track Quiz Gate retry attempts per question in Supabase so teachers can identify which pre-game concepts students struggle with.

**Architecture:** New `quiz_gate_results` Supabase table stores one row per question per student (8 rows per completion). A `session_id` UUID generated at onboarding start links quiz data to game scores for future v2.0 joins. Teacher Dashboard gets a new analytics section with question summary + expandable per-student breakdown.

**Tech Stack:** React 19, Supabase (PostgreSQL), Tailwind CSS

**Design doc:** `docs/plans/2026-02-25-v1.7.0-quiz-gate-analytics-design.md`

---

### Task 1: Supabase Migration SQL

**Files:**
- Create: `docs/migrations/001_quiz_gate_results.sql` (reference only — must be run manually in Supabase dashboard)

**Step 1: Write the migration SQL**

Create `docs/migrations/001_quiz_gate_results.sql`:

```sql
-- v1.7.0: Quiz Gate Analytics
-- Run this in the Supabase SQL Editor before deploying v1.7.0 code

-- New table for quiz gate retry tracking
CREATE TABLE quiz_gate_results (
  id BIGSERIAL PRIMARY KEY,
  session_id UUID NOT NULL,
  player_name TEXT NOT NULL,
  class_period TEXT DEFAULT '',
  game_mode TEXT DEFAULT 'historian',
  question_id TEXT NOT NULL,
  retries INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index for teacher dashboard queries (filter by period, aggregate by question)
CREATE INDEX idx_qgr_class_period ON quiz_gate_results(class_period);
CREATE INDEX idx_qgr_question_id ON quiz_gate_results(question_id);
CREATE INDEX idx_qgr_session_id ON quiz_gate_results(session_id);

-- Enable Row Level Security (match existing scores table pattern)
ALTER TABLE quiz_gate_results ENABLE ROW LEVEL SECURITY;

-- Allow anonymous inserts (students submit without auth)
CREATE POLICY "Allow anonymous inserts" ON quiz_gate_results
  FOR INSERT WITH CHECK (true);

-- Allow anonymous reads (teacher dashboard reads without auth)
CREATE POLICY "Allow anonymous reads" ON quiz_gate_results
  FOR SELECT USING (true);

-- Add session_id to existing scores table (nullable for existing rows)
ALTER TABLE scores ADD COLUMN IF NOT EXISTS session_id UUID;
CREATE INDEX IF NOT EXISTS idx_scores_session_id ON scores(session_id);
```

**Step 2: Commit**

```bash
git add docs/migrations/001_quiz_gate_results.sql
git commit -m "Add Supabase migration SQL for quiz_gate_results table"
```

> **Note:** This SQL must be run in the Supabase dashboard before deploying the code from subsequent tasks. The file is for documentation/reference only.

---

### Task 2: Add `submitQuizGateResults` and `fetchQuizGateStats` to Supabase lib

**Files:**
- Modify: `src/lib/supabase.js`

**Step 1: Add `submitQuizGateResults` function**

Add after the existing `submitScore` function (after line 60 in `src/lib/supabase.js`):

```javascript
/**
 * Submit quiz gate retry data after a student completes the pre-game quiz.
 * Inserts one row per question (8 rows total).
 */
export async function submitQuizGateResults({
  sessionId,
  playerName,
  classPeriod,
  gameMode,
  retries, // object: { qg1: 0, qg2: 2, ... }
}) {
  if (!supabase) return { error: 'Supabase not configured' };

  const rows = Object.entries(retries).map(([questionId, retryCount]) => ({
    session_id: sessionId,
    player_name: playerName,
    class_period: classPeriod || '',
    game_mode: gameMode || 'historian',
    question_id: questionId,
    retries: retryCount,
  }));

  const { data, error } = await supabase
    .from('quiz_gate_results')
    .insert(rows)
    .select();

  return { data, error };
}
```

**Step 2: Add `fetchQuizGateStats` function**

Add after the new `submitQuizGateResults` function:

```javascript
/**
 * Fetch quiz gate analytics for the teacher dashboard.
 * Returns per-question aggregates and raw per-student data.
 */
export async function fetchQuizGateStats() {
  if (!supabase) return { data: null, error: 'Supabase not configured' };

  const { data, error } = await supabase
    .from('quiz_gate_results')
    .select('*')
    .order('created_at', { ascending: false });

  if (error) return { data: null, error };

  return { data: data || [], error: null };
}
```

**Step 3: Add `session_id` parameter to `submitScore`**

Modify the `submitScore` function signature to accept `sessionId` and include it in the insert:

In the function signature, add `sessionId` after `difficulty`:
```javascript
export async function submitScore({
  playerName,
  classPeriod,
  faction,
  finalScore,
  baseScore,
  objectiveBonus,
  factionMultiplier,
  nationalismMeter,
  nativeResistance,
  navalDominance,
  knowledgeCorrect,
  knowledgeTotal,
  battlesWon,
  battlesFought,
  territoriesHeld,
  roundsPlayed,
  gameOverReason,
  difficulty,
  sessionId,
}) {
```

In the insert object, add `session_id` after `difficulty`:
```javascript
      difficulty: difficulty || 'medium',
      session_id: sessionId || null,
```

**Step 4: Build to verify no errors**

```bash
npx react-scripts build 2>&1 | tail -5
```

Expected: Build succeeds (no warnings).

**Step 5: Commit**

```bash
git add src/lib/supabase.js
git commit -m "Add submitQuizGateResults, fetchQuizGateStats, and session_id to submitScore"
```

---

### Task 3: Generate `sessionId` in App.js and thread through onboarding

**Files:**
- Modify: `src/App.js`

**Step 1: Add `sessionId` to onboarding state**

In `App.js`, modify the `onboardingData` initial state (line 19-24) to include `sessionId`:

```javascript
  const [onboardingData, setOnboardingData] = useState({
    playerName: '',
    classPeriod: '',
    difficulty: 'medium',
    gameMode: 'historian',
    sessionId: crypto.randomUUID(),
  });
```

**Step 2: Reset `sessionId` on play again**

In `handlePlayAgain` (line 82-86), generate a fresh UUID:

```javascript
  const handlePlayAgain = useCallback(() => {
    game.resetGame();
    setOnboardingStep('name');
    setOnboardingData({ playerName: '', classPeriod: '', difficulty: 'medium', gameMode: 'historian', sessionId: crypto.randomUUID() });
  }, [game]);
```

Do the same in `handleStartNewGame` (line 93-98):

```javascript
  const handleStartNewGame = () => {
    game.deleteSave();
    game.resetGame();
    setOnboardingStep('name');
    setOnboardingData({ playerName: '', classPeriod: '', difficulty: 'medium', gameMode: 'historian', sessionId: crypto.randomUUID() });
  };
```

**Step 3: Pass `sessionId` and onboarding data to LearningMode**

Modify the LearningMode render (lines 170-176) to pass additional props:

```jsx
          <LearningMode
            onComplete={handleLearningComplete}
            gameMode={onboardingData.gameMode}
            playerName={onboardingData.playerName}
            classPeriod={onboardingData.classPeriod}
            sessionId={onboardingData.sessionId}
            fontMode={fontMode}
            toggleFont={toggleFont}
          />
```

**Step 4: Pass `sessionId` through to GameBoard for ScoreSubmission**

Add `sessionId` to the `game.startGame()` call in `handleFactionSelect` (lines 72-80):

```javascript
  const handleFactionSelect = useCallback((faction) => {
    game.startGame({
      faction,
      playerName: onboardingData.playerName,
      classPeriod: onboardingData.classPeriod,
      gameMode: onboardingData.gameMode,
      difficulty: onboardingData.difficulty,
      sessionId: onboardingData.sessionId,
    });
  }, [game, onboardingData]);
```

Also pass `sessionId` as a prop to GameBoard (add after the `difficulty` prop around line 230):

```jsx
      sessionId={game.sessionId}
```

> **Note:** `game.sessionId` will need to be stored in game state. This is handled in Task 4.

**Step 5: Build to verify**

```bash
npx react-scripts build 2>&1 | tail -5
```

Expected: Build succeeds. The `game.sessionId` prop will be `undefined` until Task 4, but that's fine — no warnings for passing undefined props.

**Step 6: Commit**

```bash
git add src/App.js
git commit -m "Generate sessionId in onboarding and thread to LearningMode and GameBoard"
```

---

### Task 4: Store `sessionId` in game state

**Files:**
- Modify: `src/reducers/types.js` (if `sessionId` needs a new action — check if `START_GAME` already handles arbitrary fields)
- Modify: `src/hooks/useGameStateV2.js`

**Step 1: Check how `startGame` works**

Read `src/hooks/useGameStateV2.js` to find the `startGame` function and the `START_GAME` action handler in the game reducer. The `sessionId` field just needs to be included in the game state object that gets initialized on `START_GAME`.

Look at `src/reducers/gameReducer.js` to see how `START_GAME` handles the payload. If it spreads `action.payload` into state or picks specific fields, add `sessionId` to the picked fields.

**Step 2: Add `sessionId` to the game reducer's START_GAME handler**

In the game reducer's `START_GAME` case, add `sessionId: action.payload.sessionId || null` to the returned state.

**Step 3: Expose `sessionId` from useGameStateV2**

In `useGameStateV2.js`, add `sessionId: game.sessionId` to the returned object (wherever other game state fields are exposed).

**Step 4: Add `sessionId` to LOAD_GAME_STATE handler**

Ensure `sessionId` persists through save/load by including it in the `LOAD_GAME_STATE` case.

**Step 5: Build to verify**

```bash
npx react-scripts build 2>&1 | tail -5
```

**Step 6: Commit**

```bash
git add src/reducers/gameReducer.js src/hooks/useGameStateV2.js
git commit -m "Store sessionId in game state for score submission"
```

---

### Task 5: Track retries in LearningMode and submit on completion

**Files:**
- Modify: `src/components/LearningMode.jsx`

**Step 1: Add retries state**

Add a `retries` state object after the existing state declarations (around line 96):

```javascript
  const [retries, setRetries] = useState({});
```

**Step 2: Increment retries on wrong answer**

In `handleQuizAnswer` (lines 129-142), when the answer is wrong, increment the retry count for that question. Modify the function:

```javascript
  const handleQuizAnswer = useCallback((answerIndex) => {
    if (showResult) return;
    setSelectedAnswer(answerIndex);
    const correct = answerIndex === sectionQuestion.correctIndex;
    setIsCorrect(correct);
    setShowResult(true);

    if (correct) {
      setTimeout(() => {
        setAnsweredSections(prev => new Set(prev).add(event.id));
        resetQuizState();
      }, 1500);
    } else {
      setRetries(prev => ({
        ...prev,
        [sectionQuestion.id]: (prev[sectionQuestion.id] || 0) + 1,
      }));
    }
  }, [showResult, sectionQuestion, event.id, resetQuizState]);
```

**Step 3: Ensure all questions have an entry (even 0 retries)**

In `handleNext`, when the user reaches the last step and calls `onComplete`, we need to ensure every question ID has an entry. Modify `handleNext` (lines 113-120):

```javascript
  const handleNext = () => {
    if (currentStep < totalSteps - 1) {
      setCurrentStep(currentStep + 1);
      resetQuizState();
    } else {
      // Build complete retries object with 0 for questions answered first-try
      const completeRetries = {};
      quizGateQuestions.forEach(q => {
        completeRetries[q.id] = retries[q.id] || 0;
      });
      onComplete(completeRetries);
    }
  };
```

**Step 4: Update the `onComplete` prop signature**

The `onComplete` callback now passes `retries` as an argument. Update `App.js` to handle it.

In `App.js`, modify `handleLearningComplete` (lines 68-70):

```javascript
  const handleLearningComplete = useCallback((quizRetries) => {
    setOnboardingData(prev => ({ ...prev, quizRetries }));
    setOnboardingStep('faction');
  }, []);
```

**Step 5: Submit quiz gate results when learning completes**

Import `submitQuizGateResults` in `App.js`:

```javascript
import { submitQuizGateResults } from './lib/supabase';
```

Add submission logic inside `handleLearningComplete`:

```javascript
  const handleLearningComplete = useCallback((quizRetries) => {
    setOnboardingData(prev => ({ ...prev, quizRetries }));
    setOnboardingStep('faction');

    // Submit quiz gate analytics (fire-and-forget, don't block onboarding)
    if (quizRetries) {
      const sessionId = onboardingData.sessionId;
      // Prevent duplicate submission
      const storageKey = `war1812_qg_submitted_${sessionId}`;
      if (!localStorage.getItem(storageKey)) {
        localStorage.setItem(storageKey, 'true');
        submitQuizGateResults({
          sessionId,
          playerName: onboardingData.playerName,
          classPeriod: onboardingData.classPeriod,
          gameMode: onboardingData.gameMode,
          retries: quizRetries,
        }).catch(() => {
          // Silent failure — don't block the student
          localStorage.removeItem(storageKey);
        });
      }
    }
  }, [onboardingData]);
```

**Step 6: Build and test**

```bash
npx react-scripts build 2>&1 | tail -5
npx react-scripts test --watchAll=false 2>&1 | tail -5
```

Expected: Build succeeds, 105 tests pass.

**Step 7: Commit**

```bash
git add src/components/LearningMode.jsx src/App.js
git commit -m "Track quiz gate retries and submit to Supabase on completion"
```

---

### Task 6: Pass `sessionId` to ScoreSubmission

**Files:**
- Modify: `src/components/ScoreSubmission.jsx`
- Modify: `src/components/GameBoard.jsx` (or wherever ScoreSubmission is rendered — need to thread `sessionId` prop)

**Step 1: Add `sessionId` prop to ScoreSubmission**

In `ScoreSubmission.jsx`, add `sessionId` to the destructured props (line 31):

```javascript
export default function ScoreSubmission({
  playerName,
  classPeriod,
  playerFaction,
  finalScore,
  scores,
  objectiveBonus,
  factionMultiplier,
  nationalismMeter,
  nativeResistance,
  navalDominance,
  knowledgeCheckResults,
  battleStats,
  playerTerritoryCount,
  roundsPlayed,
  gameOverReason,
  difficulty,
  sessionId,
  onSubmitted,
}) {
```

**Step 2: Pass `sessionId` to `submitScore` call**

In `handleSubmit` (line 63), add `sessionId`:

```javascript
    const { error } = await submitScore({
      playerName,
      classPeriod,
      faction: playerFaction,
      finalScore,
      baseScore: scores[playerFaction] || 0,
      objectiveBonus,
      factionMultiplier,
      nationalismMeter: nationalismMeter || 0,
      nativeResistance: nativeResistance || 0,
      navalDominance: navalDominance || 0,
      knowledgeCorrect: knowledgeCheckResults.correct,
      knowledgeTotal: knowledgeCheckResults.total,
      battlesWon: battleStats.won,
      battlesFought: battleStats.fought,
      territoriesHeld: playerTerritoryCount,
      roundsPlayed,
      gameOverReason,
      difficulty,
      sessionId,
    });
```

**Step 3: Thread `sessionId` through GameBoard to ScoreSubmission**

Find where `ScoreSubmission` is rendered in `GameBoard.jsx` (or `GameReport.jsx`) and add the `sessionId` prop. This requires reading the file to find the exact location.

**Step 4: Build to verify**

```bash
npx react-scripts build 2>&1 | tail -5
```

**Step 5: Commit**

```bash
git add src/components/ScoreSubmission.jsx src/components/GameBoard.jsx
git commit -m "Thread sessionId through to ScoreSubmission for scores table"
```

---

### Task 7: Add Quiz Gate Analytics section to Teacher Dashboard

**Files:**
- Modify: `src/components/TeacherDashboard.jsx`

**Step 1: Import `fetchQuizGateStats` and question data**

At the top of `TeacherDashboard.jsx`, add:

```javascript
import { fetchTeacherStats, fetchQuizGateStats, verifyTeacherPassword, supabase } from '../lib/supabase';
import quizGateQuestions from '../data/quizGateQuestions';
```

**Step 2: Build question label lookup**

After the imports:

```javascript
const questionLabels = {};
quizGateQuestions.forEach(q => {
  questionLabels[q.id] = q.question;
});
```

**Step 3: Add quiz gate stats fetch to Dashboard component**

In the `Dashboard` component, add state and fetch alongside existing stats:

```javascript
  const [quizGateData, setQuizGateData] = useState([]);
  const [expandedQuestion, setExpandedQuestion] = useState(null);
```

Modify the `useEffect` to also fetch quiz gate stats:

```javascript
  useEffect(() => {
    Promise.all([
      fetchTeacherStats(),
      fetchQuizGateStats(),
    ]).then(([statsResult, qgResult]) => {
      setStats(statsResult.data);
      setQuizGateData(qgResult.data || []);
      setLoading(false);
    });
  }, []);
```

**Step 4: Compute quiz gate analytics from raw data**

Add a computation block inside Dashboard (after the `filteredScores` declaration):

```javascript
  // Quiz Gate Analytics — compute per-question aggregates
  const filteredQGData = selectedPeriod
    ? quizGateData.filter(r => r.class_period === selectedPeriod)
    : quizGateData;

  // Group by session to count unique students
  const qgSessions = new Set(filteredQGData.map(r => r.session_id));

  // Per-question stats
  const qgQuestionStats = quizGateQuestions.map(q => {
    const rows = filteredQGData.filter(r => r.question_id === q.id);
    const totalStudents = rows.length;
    const totalRetries = rows.reduce((sum, r) => sum + r.retries, 0);
    const firstTryCount = rows.filter(r => r.retries === 0).length;
    return {
      id: q.id,
      question: q.question,
      totalStudents,
      avgRetries: totalStudents > 0 ? (totalRetries / totalStudents) : 0,
      firstTryPercent: totalStudents > 0 ? Math.round((firstTryCount / totalStudents) * 100) : 0,
      rows, // for student breakdown
    };
  }).sort((a, b) => b.avgRetries - a.avgRetries);
```

**Step 5: Add Quiz Gate Analytics CSV export**

Add a new export function inside Dashboard:

```javascript
  const exportQuizGateCSV = () => {
    const headers = ['Student', 'Period', 'Mode', 'Question', 'Retries', 'Date'];
    const rows = filteredQGData.map(r => [
      r.player_name,
      r.class_period,
      r.game_mode,
      questionLabels[r.question_id] || r.question_id,
      r.retries,
      new Date(r.created_at).toLocaleDateString(),
    ]);
    const csv = [headers, ...rows].map(r => r.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `war1812_quiz_gate${selectedPeriod ? `_${selectedPeriod}` : ''}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };
```

**Step 6: Add the Quiz Gate Analytics UI section**

Add the following JSX after the "Faction Distribution" section and before the "All Scores" section (after the closing `</div>` around line 250):

```jsx
        {/* Quiz Gate Analytics */}
        <div className="bg-war-navy/50 rounded-lg p-5 border border-parchment-dark/8">
          <div className="flex items-center justify-between mb-4 flex-wrap gap-3">
            <div>
              <h2 className="text-war-gold/80 font-display text-base tracking-wide">Quiz Gate Analytics</h2>
              <p className="text-parchment-dark/40 text-xs font-body mt-0.5">
                {qgSessions.size} students completed the pre-game quiz
              </p>
            </div>
            {filteredQGData.length > 0 && (
              <button
                onClick={exportQuizGateCSV}
                className="px-4 py-1.5 text-xs border border-parchment-dark/15 text-parchment-dark/50 rounded
                           hover:border-war-gold/40 hover:text-war-gold transition-colors cursor-pointer font-body"
              >
                Export Quiz CSV
              </button>
            )}
          </div>

          {filteredQGData.length === 0 ? (
            <p className="text-parchment-dark/40 italic font-body text-sm">No quiz gate data yet</p>
          ) : (
            <div className="space-y-1">
              {/* Question Summary Table */}
              <table className="w-full text-sm font-body">
                <thead>
                  <tr className="text-parchment-dark/40 border-b border-parchment-dark/15 text-left">
                    <th className="py-2 font-normal">#</th>
                    <th className="py-2 font-normal">Question</th>
                    <th className="py-2 text-right font-normal">Avg Retries</th>
                    <th className="py-2 text-right font-normal">First-Try %</th>
                    <th className="py-2 text-right font-normal">Students</th>
                  </tr>
                </thead>
                <tbody>
                  {qgQuestionStats.map((q, idx) => (
                    <React.Fragment key={q.id}>
                      <tr
                        className="border-b border-parchment-dark/8 cursor-pointer hover:bg-war-gold/5 transition-colors"
                        onClick={() => setExpandedQuestion(expandedQuestion === q.id ? null : q.id)}
                      >
                        <td className="py-2 text-parchment-dark/50">{idx + 1}</td>
                        <td className="py-2 text-parchment/80 max-w-xs">
                          <span className="line-clamp-1">{q.question}</span>
                        </td>
                        <td className="py-2 text-right font-bold font-display text-parchment/80">
                          {q.avgRetries.toFixed(1)}
                        </td>
                        <td className="py-2 text-right">
                          <span className={`font-bold font-display ${
                            q.firstTryPercent >= 70 ? 'text-green-400' :
                            q.firstTryPercent >= 40 ? 'text-yellow-400' :
                            'text-red-400'
                          }`}>
                            {q.firstTryPercent}%
                          </span>
                        </td>
                        <td className="py-2 text-right text-parchment-dark/60">{q.totalStudents}</td>
                      </tr>
                      {/* Expanded student breakdown */}
                      {expandedQuestion === q.id && q.rows.length > 0 && (
                        <tr>
                          <td colSpan={5} className="p-0">
                            <div className="bg-black/20 border-l-2 border-war-gold/20 ml-4 mb-2 rounded-r">
                              <table className="w-full text-xs font-body">
                                <thead>
                                  <tr className="text-parchment-dark/40 border-b border-parchment-dark/10">
                                    <th className="py-1.5 px-3 font-normal text-left">Student</th>
                                    <th className="py-1.5 px-3 font-normal text-left">Period</th>
                                    <th className="py-1.5 px-3 font-normal text-left">Mode</th>
                                    <th className="py-1.5 px-3 font-normal text-right">Retries</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  {[...q.rows].sort((a, b) => b.retries - a.retries).map((r, i) => (
                                    <tr key={i} className="border-b border-parchment-dark/5">
                                      <td className="py-1.5 px-3 text-parchment/70">{r.player_name}</td>
                                      <td className="py-1.5 px-3 text-parchment-dark/50">{r.class_period}</td>
                                      <td className="py-1.5 px-3 text-parchment-dark/50 capitalize">{r.game_mode}</td>
                                      <td className="py-1.5 px-3 text-right">
                                        <span className={`font-bold ${r.retries === 0 ? 'text-green-400' : r.retries <= 2 ? 'text-yellow-400' : 'text-red-400'}`}>
                                          {r.retries}
                                        </span>
                                      </td>
                                    </tr>
                                  ))}
                                </tbody>
                              </table>
                            </div>
                          </td>
                        </tr>
                      )}
                    </React.Fragment>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
```

**Step 7: Build and test**

```bash
npx react-scripts build 2>&1 | tail -5
npx react-scripts test --watchAll=false 2>&1 | tail -5
```

Expected: Build succeeds, 105 tests pass.

**Step 8: Commit**

```bash
git add src/components/TeacherDashboard.jsx
git commit -m "Add Quiz Gate Analytics section to Teacher Dashboard"
```

---

### Task 8: Version bump and changelog

**Files:**
- Modify: `src/data/changelog.js`
- Modify: `README.md`

**Step 1: Update changelog.js**

Change `CURRENT_VERSION` from `'1.6.0'` to `'1.7.0'`.

Add new changelog entry at the top of the array:

```javascript
  {
    version: '1.7.0',
    date: '2026-02-25',
    title: 'Quiz Gate Analytics',
    changes: [
      'Pre-game quiz retry tracking — teachers can see which questions students struggle with',
      'New Quiz Gate Analytics section on Teacher Dashboard with per-question breakdown',
      'Expandable student detail view showing individual retry counts',
      'Quiz Gate CSV export for offline analysis',
      'Session ID linking quiz gate data to game scores (future-proofing for v2.0)',
    ],
  },
```

**Step 2: Update README.md**

- Change version in header from `1.6.0` to `1.7.0`
- Add v1.7.0 section under "Latest Features"
- Add v1.7.0 row to version history table
- Update "Current Status" line

**Step 3: Build and test**

```bash
npx react-scripts build 2>&1 | tail -5
npx react-scripts test --watchAll=false 2>&1 | tail -5
```

Expected: Build succeeds, 105 tests pass.

**Step 4: Commit**

```bash
git add src/data/changelog.js README.md
git commit -m "Bump to v1.7.0 with Quiz Gate Analytics changelog and README"
```

---

### Task 9: Run Supabase migration and deploy

**Step 1: Run migration SQL in Supabase dashboard**

Open the Supabase dashboard SQL editor and run the contents of `docs/migrations/001_quiz_gate_results.sql`.

**Step 2: Final build + test verification**

```bash
npx react-scripts build 2>&1 | tail -5
npx react-scripts test --watchAll=false 2>&1 | tail -5
```

Expected: Build succeeds with 0 warnings, 105 tests pass.

**Step 3: Push and deploy**

```bash
git push
npm run deploy
```

---

## File Summary

| File | Action |
|------|--------|
| `docs/migrations/001_quiz_gate_results.sql` | Create (migration reference) |
| `src/lib/supabase.js` | Modify (add 2 functions + sessionId param) |
| `src/App.js` | Modify (generate sessionId, thread props, submit on completion) |
| `src/reducers/gameReducer.js` | Modify (store sessionId in game state) |
| `src/hooks/useGameStateV2.js` | Modify (expose sessionId) |
| `src/components/LearningMode.jsx` | Modify (track retries, pass to onComplete) |
| `src/components/ScoreSubmission.jsx` | Modify (accept + pass sessionId) |
| `src/components/GameBoard.jsx` | Modify (thread sessionId to ScoreSubmission) |
| `src/components/TeacherDashboard.jsx` | Modify (new analytics section) |
| `src/data/changelog.js` | Modify (version bump) |
| `README.md` | Modify (version bump) |
