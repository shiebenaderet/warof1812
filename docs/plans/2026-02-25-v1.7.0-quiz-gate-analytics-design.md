# v1.7.0 Design: Quiz Gate Analytics

**Date:** 2026-02-25
**Status:** Approved

## Goal

Track Quiz Gate retry attempts per question in Supabase so teachers can see which concepts students struggle with before gameplay begins.

## Scope

- **Quiz Gate only** (8 pre-game comprehension questions in LearningMode)
- In-game Knowledge Checks are out of scope for this release
- No gameplay code changes

## Data Flow

```
Onboarding Start (NameEntry/App.js)
  └─ Generate session_id (crypto.randomUUID())
       │
       ├─ Thread through onboarding state as prop
       │
Quiz Gate (LearningMode)
  └─ Track retries per question in local state
       │  { qg1: 0, qg2: 2, qg3: 0, ... }
       │
Quiz Gate Complete
  └─ Submit 8 rows to quiz_gate_results table
       │  (one row per question, includes session_id)
       │
Game Plays...
       │
Score Submission
  └─ Existing scores table gets session_id column
       (links quiz gate data to game results for v2.0 joins)
```

## Supabase Schema

### New table: `quiz_gate_results`

| Column | Type | Purpose |
|--------|------|---------|
| `id` | bigint (auto) | Primary key |
| `session_id` | uuid | Links to game session (joins to `scores` in v2.0) |
| `player_name` | text | Student name |
| `class_period` | text | For teacher filtering |
| `game_mode` | text | 'historian' or 'explorer' |
| `question_id` | text | 'qg1' through 'qg8' |
| `retries` | int | Wrong attempts before correct (0 = first try) |
| `created_at` | timestamptz | Auto, default now() |

One row per question per student (8 rows per Quiz Gate completion).

### Alter table: `scores`

Add `session_id` uuid column (nullable — existing rows won't have it).

## Teacher Dashboard UI

### Question Summary Table (new section)

One row per Quiz Gate question (8 rows):
- Question text (truncated)
- Average retries across all students
- First-try % (students who got it with 0 retries)
- Total students tested
- Color coding: green (≥70% first-try), yellow (40-69%), red (<40%)
- Sorted by average retries descending (hardest first)
- Filterable by class period (reuses existing filter)

### Student Breakdown (expandable row)

Clicking a question row expands to show per-student data:
- Student name, period, game mode, retries
- Sorted by retries descending (struggling students first)

### CSV Export

New "Quiz Gate Analytics" CSV export button alongside existing export.

## Files Modified

| File | Change |
|------|--------|
| `src/App.js` | Generate `session_id`, thread as prop |
| `src/components/LearningMode.jsx` | Track retries, call `submitQuizGateResults()` |
| `src/components/ScoreSubmission.jsx` | Pass `session_id` to `submitScore()` |
| `src/lib/supabase.js` | Add `submitQuizGateResults()`, `fetchQuizGateStats()`, add `session_id` to `submitScore()` |
| `src/components/TeacherDashboard.jsx` | Quiz Gate Analytics section |
| `src/data/changelog.js` | Bump to 1.7.0 |
| `README.md` | Update version + features |

## No Changes To

- Reducers, useGameStateV2, useAI, game logic
- KnowledgeCheck component
- Save/load system
- quizGateQuestions.js

## Risks & Mitigations

1. **Supabase migration is manual** — SQL must be run in Supabase dashboard before deploying code
2. **Duplicate submissions** — Use localStorage flag keyed on `session_id` to prevent double-insert
3. **Offline/failure** — Try/catch with silent failure (don't block onboarding if Supabase is down)
4. **Nullable session_id on scores** — Existing rows won't have it; join only matters in v2.0

## Future (v2.0)

When the Class Code System ships, `quiz_gate_results` can be joined to `scores` via `session_id` to correlate pre-game struggles with in-game performance, scoped by teacher/class code.
