# Class Code System Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Replace the shared-password Teacher Dashboard with Supabase Auth so each teacher has an isolated view of only their students' data, connected via class codes.

**Architecture:** Supabase Auth (magic link + password) for teachers. New `teachers` and `classes` tables. Students enter optional class code during onboarding or at score submission (late join). Teacher Dashboard fully rewritten with auth, class management, and scoped data. Global leaderboard unchanged.

**Tech Stack:** React 19, Supabase Auth + PostgreSQL + RLS, Tailwind CSS

**Design doc:** `docs/plans/2026-02-25-v2.0.0-class-code-system-design.md`

---

### Task 1: Supabase Migration SQL

**Files:**
- Create: `docs/migrations/002_class_code_system.sql`

**Step 1: Write the migration SQL**

Create `docs/migrations/002_class_code_system.sql`:

```sql
-- v2.0.0: Class Code System
-- Run this in the Supabase SQL Editor before deploying v2.0.0 code
-- IMPORTANT: Enable Email Auth in Supabase Dashboard > Authentication > Providers first
-- Also set Site URL to https://1812.mrbsocialstudies.org
-- Also add https://1812.mrbsocialstudies.org to Redirect URLs

-- ============================================
-- NEW TABLES
-- ============================================

-- Teachers table (linked to Supabase auth.users)
CREATE TABLE teachers (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  display_name TEXT NOT NULL,
  email TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Classes table (teacher creates classes, students join via code)
CREATE TABLE classes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  teacher_id UUID NOT NULL REFERENCES teachers(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  code TEXT NOT NULL UNIQUE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_classes_teacher_id ON classes(teacher_id);
CREATE INDEX idx_classes_code ON classes(code);

-- ============================================
-- ALTER EXISTING TABLES
-- ============================================

-- Add class_id to scores (nullable — existing rows and standalone students have no class)
ALTER TABLE scores ADD COLUMN IF NOT EXISTS class_id UUID REFERENCES classes(id);
CREATE INDEX IF NOT EXISTS idx_scores_class_id ON scores(class_id);

-- Add class_id to quiz_gate_results (nullable — same reason)
ALTER TABLE quiz_gate_results ADD COLUMN IF NOT EXISTS class_id UUID REFERENCES classes(id);
CREATE INDEX IF NOT EXISTS idx_qgr_class_id ON quiz_gate_results(class_id);

-- ============================================
-- ROW LEVEL SECURITY
-- ============================================

-- Teachers: only own row
ALTER TABLE teachers ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Teachers can insert own row" ON teachers
  FOR INSERT TO authenticated
  WITH CHECK (id = auth.uid());

CREATE POLICY "Teachers can read own row" ON teachers
  FOR SELECT TO authenticated
  USING (id = auth.uid());

CREATE POLICY "Teachers can update own row" ON teachers
  FOR UPDATE TO authenticated
  USING (id = auth.uid())
  WITH CHECK (id = auth.uid());

-- Classes: teachers manage own, anon can read by code
ALTER TABLE classes ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Teachers can insert own classes" ON classes
  FOR INSERT TO authenticated
  WITH CHECK (teacher_id = auth.uid());

CREATE POLICY "Teachers can read own classes" ON classes
  FOR SELECT TO authenticated
  USING (teacher_id = auth.uid());

CREATE POLICY "Teachers can update own classes" ON classes
  FOR UPDATE TO authenticated
  USING (teacher_id = auth.uid());

CREATE POLICY "Teachers can delete own classes" ON classes
  FOR DELETE TO authenticated
  USING (teacher_id = auth.uid());

CREATE POLICY "Anon can read classes by code" ON classes
  FOR SELECT TO public
  USING (true);

-- Scores: keep existing anon policies, add teacher scoped read
-- First check existing policies and only create if missing
DO $$
BEGIN
  -- Add teacher scoped read for scores
  IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'scores' AND policyname = 'Teachers can read class scores') THEN
    CREATE POLICY "Teachers can read class scores" ON scores
      FOR SELECT TO authenticated
      USING (class_id IN (SELECT id FROM classes WHERE teacher_id = auth.uid()));
  END IF;
END $$;

-- Allow anon to update class_id on scores (for late join via session_id)
CREATE POLICY "Anon can update class_id on scores" ON scores
  FOR UPDATE TO public
  USING (true)
  WITH CHECK (true);

-- Quiz gate results: add teacher scoped read
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'quiz_gate_results' AND policyname = 'Teachers can read class quiz results') THEN
    CREATE POLICY "Teachers can read class quiz results" ON quiz_gate_results
      FOR SELECT TO authenticated
      USING (class_id IN (SELECT id FROM classes WHERE teacher_id = auth.uid()));
  END IF;
END $$;

-- Allow anon to update class_id on quiz_gate_results (for late join)
CREATE POLICY "Anon can update class_id on quiz results" ON quiz_gate_results
  FOR UPDATE TO public
  USING (true)
  WITH CHECK (true);

-- ============================================
-- GRANTS
-- ============================================

GRANT ALL ON teachers TO authenticated;
GRANT ALL ON classes TO authenticated;
GRANT SELECT ON classes TO anon;
GRANT UPDATE ON scores TO anon;
GRANT UPDATE ON quiz_gate_results TO anon;
GRANT USAGE ON ALL SEQUENCES IN SCHEMA public TO anon;
GRANT USAGE ON ALL SEQUENCES IN SCHEMA public TO authenticated;
```

**Step 2: Commit**

```bash
git add docs/migrations/002_class_code_system.sql
git commit -m "Add Supabase migration SQL for class code system"
```

> **Note:** This SQL must be run in the Supabase dashboard SQL Editor before deploying code. Also enable Email auth provider and configure Site URL + Redirect URLs in Authentication settings.

---

### Task 2: Add auth and class functions to Supabase lib

**Files:**
- Modify: `src/lib/supabase.js`

**Step 1: Add auth helper functions**

Add after the existing `verifyTeacherPassword` function (which will be removed in a later task):

```javascript
// ============================================
// Auth Functions
// ============================================

/**
 * Sign up a new teacher with email and password.
 */
export async function signUpTeacher(email, password) {
  if (!supabase) return { data: null, error: 'Supabase not configured' };
  const { data, error } = await supabase.auth.signUp({ email, password });
  return { data, error };
}

/**
 * Sign in a teacher with email and password.
 */
export async function signInWithPassword(email, password) {
  if (!supabase) return { data: null, error: 'Supabase not configured' };
  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  return { data, error };
}

/**
 * Send a magic link to the teacher's email.
 */
export async function signInWithMagicLink(email) {
  if (!supabase) return { data: null, error: 'Supabase not configured' };
  const { data, error } = await supabase.auth.signInWithOtp({
    email,
    options: { emailRedirectTo: `${window.location.origin}/#teacher` },
  });
  return { data, error };
}

/**
 * Sign out the current teacher.
 */
export async function signOut() {
  if (!supabase) return { error: 'Supabase not configured' };
  const { error } = await supabase.auth.signOut();
  return { error };
}

/**
 * Get current auth session.
 */
export async function getSession() {
  if (!supabase) return { data: null, error: 'Supabase not configured' };
  const { data, error } = await supabase.auth.getSession();
  return { data, error };
}

/**
 * Subscribe to auth state changes. Returns an unsubscribe function.
 */
export function onAuthStateChange(callback) {
  if (!supabase) return { data: { subscription: { unsubscribe: () => {} } } };
  return supabase.auth.onAuthStateChange(callback);
}
```

**Step 2: Add teacher profile functions**

```javascript
// ============================================
// Teacher Profile Functions
// ============================================

/**
 * Get teacher profile for the current authenticated user.
 */
export async function getTeacherProfile(userId) {
  if (!supabase) return { data: null, error: 'Supabase not configured' };
  const { data, error } = await supabase
    .from('teachers')
    .select('*')
    .eq('id', userId)
    .single();
  return { data, error };
}

/**
 * Create teacher profile (called on first login).
 */
export async function createTeacherProfile({ userId, displayName, email }) {
  if (!supabase) return { data: null, error: 'Supabase not configured' };
  const { data, error } = await supabase
    .from('teachers')
    .insert([{ id: userId, display_name: displayName, email }])
    .select()
    .single();
  return { data, error };
}
```

**Step 3: Add class management functions**

```javascript
// ============================================
// Class Management Functions
// ============================================

/**
 * Generate a random 6-character alphanumeric class code.
 */
function generateClassCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // No I/1/O/0 to avoid confusion
  let code = '';
  for (let i = 0; i < 6; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return code;
}

/**
 * Create a new class for the authenticated teacher.
 */
export async function createClass({ teacherId, name }) {
  if (!supabase) return { data: null, error: 'Supabase not configured' };

  // Try up to 3 times in case of code collision
  for (let attempt = 0; attempt < 3; attempt++) {
    const code = generateClassCode();
    const { data, error } = await supabase
      .from('classes')
      .insert([{ teacher_id: teacherId, name, code }])
      .select()
      .single();

    if (!error) return { data, error: null };
    if (!error.message?.includes('duplicate')) return { data: null, error };
  }
  return { data: null, error: { message: 'Failed to generate unique code' } };
}

/**
 * Fetch all classes for the authenticated teacher.
 */
export async function fetchTeacherClasses(teacherId) {
  if (!supabase) return { data: [], error: 'Supabase not configured' };
  const { data, error } = await supabase
    .from('classes')
    .select('*')
    .eq('teacher_id', teacherId)
    .order('created_at', { ascending: true });
  return { data: data || [], error };
}

/**
 * Validate a class code entered by a student.
 * Returns the class record if valid, null if not found.
 */
export async function validateClassCode(code) {
  if (!supabase) return { data: null, error: 'Supabase not configured' };
  const { data, error } = await supabase
    .from('classes')
    .select('id, name, code')
    .eq('code', code.toUpperCase().trim())
    .single();

  if (error?.code === 'PGRST116') return { data: null, error: null }; // Not found
  return { data, error };
}
```

**Step 4: Add class_id parameter to submitScore**

In the `submitScore` function signature, add `classId` after `sessionId`:

```javascript
export async function submitScore({
  // ... existing params ...
  sessionId,
  classId,
}) {
```

In the insert object, add after `session_id`:

```javascript
      session_id: sessionId || null,
      class_id: classId || null,
```

**Step 5: Add class_id parameter to submitQuizGateResults**

In the `submitQuizGateResults` function signature, add `classId` after `retries`:

```javascript
export async function submitQuizGateResults({
  sessionId,
  playerName,
  classPeriod,
  gameMode,
  retries,
  classId,
}) {
```

In the row mapping, add:

```javascript
    class_id: classId || null,
```

**Step 6: Add retroactive class linking function**

```javascript
/**
 * Retroactively link a student's quiz gate results and score to a class
 * via their session_id. Used when a student enters a class code at score submission.
 */
export async function linkSessionToClass({ sessionId, classId }) {
  if (!supabase || !sessionId || !classId) return { error: 'Missing params' };

  // Update quiz_gate_results
  await supabase
    .from('quiz_gate_results')
    .update({ class_id: classId })
    .eq('session_id', sessionId);

  // Update scores
  await supabase
    .from('scores')
    .update({ class_id: classId })
    .eq('session_id', sessionId);

  return { error: null };
}
```

**Step 7: Update fetchTeacherStats to accept class IDs filter**

Replace the existing `fetchTeacherStats` function:

```javascript
/**
 * Fetch aggregate stats for the teacher dashboard, scoped to given class IDs.
 */
export async function fetchTeacherStats(classIds) {
  if (!supabase) return { data: null, error: 'Supabase not configured' };

  let query = supabase
    .from('scores')
    .select('*')
    .order('created_at', { ascending: false });

  if (classIds && classIds.length > 0) {
    query = query.in('class_id', classIds);
  }

  const { data, error } = await query;

  if (error) return { data: null, error };

  const scores = data || [];

  // Aggregate by class_id (replaces old period aggregation for scoped view)
  const byClass = {};
  const byFaction = { us: [], british: [], native: [] };

  for (const s of scores) {
    const classId = s.class_id || 'unassigned';
    if (!byClass[classId]) byClass[classId] = [];
    byClass[classId].push(s);
    if (byFaction[s.faction]) byFaction[s.faction].push(s);
  }

  const classStats = Object.entries(byClass).map(([classId, entries]) => ({
    classId,
    count: entries.length,
    avgScore: Math.round(entries.reduce((a, e) => a + e.final_score, 0) / entries.length),
    avgQuizPercent: entries.filter(e => e.knowledge_total > 0).length > 0
      ? Math.round(
          entries.filter(e => e.knowledge_total > 0)
            .reduce((a, e) => a + (e.knowledge_correct / e.knowledge_total) * 100, 0)
          / entries.filter(e => e.knowledge_total > 0).length
        )
      : 0,
    topScore: Math.max(...entries.map(e => e.final_score)),
  }));

  const factionStats = Object.entries(byFaction).map(([faction, entries]) => ({
    faction,
    count: entries.length,
    avgScore: entries.length > 0
      ? Math.round(entries.reduce((a, e) => a + e.final_score, 0) / entries.length)
      : 0,
  }));

  return {
    data: {
      totalGames: scores.length,
      allScores: scores,
      classStats,
      factionStats,
    },
    error: null,
  };
}
```

**Step 8: Update fetchQuizGateStats to accept class IDs filter**

Replace the existing `fetchQuizGateStats` function:

```javascript
/**
 * Fetch quiz gate analytics, scoped to given class IDs.
 */
export async function fetchQuizGateStats(classIds) {
  if (!supabase) return { data: null, error: 'Supabase not configured' };

  let query = supabase
    .from('quiz_gate_results')
    .select('*')
    .order('created_at', { ascending: false });

  if (classIds && classIds.length > 0) {
    query = query.in('class_id', classIds);
  }

  const { data, error } = await query;

  if (error) return { data: null, error };

  return { data: data || [], error: null };
}
```

**Step 9: Remove verifyTeacherPassword**

Delete the `verifyTeacherPassword` function entirely:

```javascript
// DELETE THIS:
export function verifyTeacherPassword(password) {
  const expected = process.env.REACT_APP_TEACHER_PASSWORD || 'teacher1812';
  return password === expected;
}
```

**Step 10: Build to verify**

```bash
npx react-scripts build 2>&1 | tail -5
```

Note: Build may show a warning about unused `verifyTeacherPassword` import in TeacherDashboard.jsx — that's expected and will be fixed in Task 6.

**Step 11: Commit**

```bash
git add src/lib/supabase.js
git commit -m "Add auth, class management, and scoped query functions to Supabase lib"
```

---

### Task 3: Thread classId through game state

**Files:**
- Modify: `src/App.js`
- Modify: `src/hooks/useGameStateV2.js`
- Modify: `src/reducers/gameReducer.js`

**Step 1: Add classId to App.js onboarding data**

In the `onboardingData` initial state, add `classId: null`:

```javascript
  const [onboardingData, setOnboardingData] = useState({
    playerName: '',
    classPeriod: '',
    difficulty: 'medium',
    gameMode: 'historian',
    sessionId: generateUUID(),
    classId: null,
  });
```

**Step 2: Read `?class=` URL parameter in App.js**

After the `skipLearning` line, add:

```javascript
  const classParam = new URLSearchParams(window.location.search).get('class') || '';
```

Pass `classParam` to NameEntry:

```jsx
          <NameEntry
            onNext={handleNameNext}
            classParam={classParam}
            // ... other existing props ...
          />
```

**Step 3: Update handleNameNext to accept classId and classPeriod**

Replace the existing `handleNameNext`:

```javascript
  const handleNameNext = useCallback(({ playerName, classPeriod, classId }) => {
    setOnboardingData(prev => ({ ...prev, playerName, classPeriod, classId }));
    setOnboardingStep('difficulty');
  }, []);
```

**Step 4: Pass classId to handleLearningComplete submission**

In `handleLearningComplete`, add `classId` to the `submitQuizGateResults` call:

```javascript
        submitQuizGateResults({
          sessionId,
          playerName: onboardingData.playerName,
          classPeriod: onboardingData.classPeriod,
          gameMode: onboardingData.gameMode,
          retries: quizRetries,
          classId: onboardingData.classId,
        })
```

**Step 5: Pass classId to handleFactionSelect**

Add `classId` to the `game.startGame()` call:

```javascript
    game.startGame({
      faction,
      playerName: onboardingData.playerName,
      classPeriod: onboardingData.classPeriod,
      gameMode: onboardingData.gameMode,
      difficulty: onboardingData.difficulty,
      sessionId: onboardingData.sessionId,
      classId: onboardingData.classId,
    });
```

**Step 6: Pass classId to GameBoard**

Add after the `sessionId` prop:

```jsx
      classId={game.classId}
```

**Step 7: Reset classId in handlePlayAgain and handleStartNewGame**

Both already reset to a fresh object — just add `classId: null`:

```javascript
    setOnboardingData({ playerName: '', classPeriod: '', difficulty: 'medium', gameMode: 'historian', sessionId: generateUUID(), classId: null });
```

Do this in both `handlePlayAgain` and `handleStartNewGame`.

**Step 8: Update useGameStateV2.js**

In the `startGame` destructuring, add `classId`:

```javascript
  const startGame = useCallback(({ faction, playerName: name, classPeriod: period, gameMode, difficulty, sessionId, classId }) => {
```

Add `classId` to the dispatch payload:

```javascript
    dispatchGame({ type: GAME_START, payload: { faction, name, period, gameMode, difficulty, sessionId, classId } });
```

Add `classId` to the returned object:

```javascript
    classId: gameState.classId,
```

**Step 9: Update gameReducer.js**

In the `GAME_START` case, add:

```javascript
        classId: action.payload.classId || null,
```

In the `LOAD_GAME_STATE` case, add:

```javascript
        classId: action.payload?.classId || null,
```

**Step 10: Thread classId through GameBoard → GameReport → ScoreSubmission**

In `GameBoard.jsx`, add `classId` to the destructured props and pass it to `GameReport`:

```jsx
  classId={classId}
```

In `GameReport.jsx`, add `classId` to the destructured props and pass it to `ScoreSubmission`:

```jsx
  classId={classId}
```

In `ScoreSubmission.jsx`, add `classId` to the destructured props and pass it to `submitScore`:

```javascript
      classId,
```

**Step 11: Build and test**

```bash
npx react-scripts build 2>&1 | tail -5
npx react-scripts test --watchAll=false 2>&1 | tail -5
```

Expected: Build succeeds (maybe with unused import warning for TeacherDashboard), 105 tests pass.

**Step 12: Commit**

```bash
git add src/App.js src/hooks/useGameStateV2.js src/reducers/gameReducer.js src/components/GameBoard.jsx src/components/GameReport.jsx src/components/ScoreSubmission.jsx
git commit -m "Thread classId through game state, onboarding, and score submission"
```

---

### Task 4: Update NameEntry with class code field

**Files:**
- Modify: `src/components/NameEntry.jsx`

**Step 1: Add imports and state**

Add to imports:

```javascript
import { validateClassCode } from '../lib/supabase';
```

Add state variables after existing state:

```javascript
  const [classCode, setClassCode] = useState(classParam || '');
  const [classData, setClassData] = useState(null); // { id, name, code } when validated
  const [classError, setClassError] = useState('');
  const [validatingCode, setValidatingCode] = useState(false);
  const [useClassCode, setUseClassCode] = useState(!!classParam);
```

Add `classParam` to destructured props:

```javascript
export default function NameEntry({
  onNext,
  classParam,
  // ... rest unchanged
}) {
```

**Step 2: Add class code validation function**

```javascript
  const handleValidateCode = async (code) => {
    if (!code.trim()) {
      setClassData(null);
      setClassError('');
      return;
    }
    setValidatingCode(true);
    setClassError('');
    const { data, error } = await validateClassCode(code);
    setValidatingCode(false);
    if (error) {
      setClassError('Could not validate code. Try again.');
    } else if (!data) {
      setClassError('Code not found — check with your teacher');
      setClassData(null);
    } else {
      setClassData(data);
      setClassError('');
    }
  };
```

**Step 3: Auto-validate classParam on mount**

```javascript
  React.useEffect(() => {
    if (classParam) {
      handleValidateCode(classParam);
    }
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);
```

**Step 4: Update handleContinue**

Replace the existing `handleContinue`:

```javascript
  const handleContinue = () => {
    if (!playerName.trim()) return;
    if (useClassCode && classData) {
      onNext({
        playerName: playerName.trim(),
        classPeriod: classData.name,
        classId: classData.id,
      });
    } else {
      onNext({
        playerName: playerName.trim(),
        classPeriod: classPeriod.trim() || 'Unassigned',
        classId: null,
      });
    }
  };
```

**Step 5: Replace the Class Period input section in JSX**

Replace the entire `{/* Class Period Input */}` section (lines 86-100) with:

```jsx
          {/* Class Code / Period Input */}
          <div className="mb-6">
            {useClassCode ? (
              <>
                <label className="block text-parchment/60 text-xs uppercase tracking-wider mb-1.5 font-body font-bold">
                  Class Code <span className="text-parchment-dark/30">(from your teacher)</span>
                </label>
                <div className="flex gap-2">
                  <input
                    type="text"
                    value={classCode}
                    onChange={(e) => {
                      const val = e.target.value.toUpperCase().slice(0, 6);
                      setClassCode(val);
                      if (val.length === 6) handleValidateCode(val);
                      else { setClassData(null); setClassError(''); }
                    }}
                    onKeyDown={handleKeyDown}
                    placeholder="e.g., ABC123"
                    maxLength={6}
                    className="flex-1 bg-war-ink/50 border border-parchment-dark/15 rounded px-4 py-3 text-parchment/90
                               placeholder-parchment-dark/30 font-body font-mono tracking-widest text-center uppercase
                               focus:border-war-gold/40 focus:outline-none transition-colors"
                  />
                </div>
                {validatingCode && (
                  <p className="text-parchment-dark/40 text-xs mt-1.5 font-body italic">Checking code...</p>
                )}
                {classError && (
                  <p className="text-red-400 text-xs mt-1.5 font-body">{classError}</p>
                )}
                {classData && (
                  <p className="text-green-400 text-xs mt-1.5 font-body">
                    Joined: {classData.name}
                  </p>
                )}
                <button
                  type="button"
                  onClick={() => { setUseClassCode(false); setClassData(null); setClassError(''); }}
                  className="text-parchment-dark/40 text-xs font-body mt-2 hover:text-parchment/60 transition-colors cursor-pointer"
                >
                  No class code? Enter period instead
                </button>
              </>
            ) : (
              <>
                <label className="block text-parchment/60 text-xs uppercase tracking-wider mb-1.5 font-body font-bold">
                  Class Period <span className="text-parchment-dark/30">(optional)</span>
                </label>
                <input
                  type="text"
                  value={classPeriod}
                  onChange={(e) => setClassPeriod(e.target.value.slice(0, 10))}
                  onKeyDown={handleKeyDown}
                  placeholder="e.g., Period 3"
                  className="w-full bg-war-ink/50 border border-parchment-dark/15 rounded px-4 py-3 text-parchment/90
                             placeholder-parchment-dark/30 font-body focus:border-war-gold/40 focus:outline-none transition-colors"
                />
                <button
                  type="button"
                  onClick={() => setUseClassCode(true)}
                  className="text-parchment-dark/40 text-xs font-body mt-2 hover:text-parchment/60 transition-colors cursor-pointer"
                >
                  Have a class code? Enter it here
                </button>
              </>
            )}
          </div>
```

**Step 6: Update the Continue button disabled state**

The Continue button should be disabled if using a class code that hasn't been validated:

```jsx
            disabled={!playerName.trim() || (useClassCode && classCode.trim() && !classData)}
```

**Step 7: Build and test**

```bash
npx react-scripts build 2>&1 | tail -5
npx react-scripts test --watchAll=false 2>&1 | tail -5
```

**Step 8: Commit**

```bash
git add src/components/NameEntry.jsx
git commit -m "Replace period field with class code input in NameEntry"
```

---

### Task 5: Add late join class code to ScoreSubmission

**Files:**
- Modify: `src/components/ScoreSubmission.jsx`

**Step 1: Add imports and state**

Add to imports:

```javascript
import { submitScore, supabase, validateClassCode, linkSessionToClass } from '../lib/supabase';
```

Add `classId` and `sessionId` to destructured props (sessionId already exists, classId is new).

Add state after existing state:

```javascript
  const [lateClassCode, setLateClassCode] = useState('');
  const [lateClassData, setLateClassData] = useState(null);
  const [lateClassError, setLateClassError] = useState('');
  const [lateValidating, setLateValidating] = useState(false);
```

**Step 2: Add late join validation function**

```javascript
  const handleLateValidate = async (code) => {
    if (!code.trim()) { setLateClassData(null); setLateClassError(''); return; }
    setLateValidating(true);
    setLateClassError('');
    const { data, error } = await validateClassCode(code);
    setLateValidating(false);
    if (error) { setLateClassError('Could not validate code.'); }
    else if (!data) { setLateClassError('Code not found'); setLateClassData(null); }
    else { setLateClassData(data); setLateClassError(''); }
  };
```

**Step 3: Update handleSubmit to use late join classId**

Modify `handleSubmit` to use the late join class if available:

```javascript
  const handleSubmit = async () => {
    setStatus('submitting');
    setErrorMsg('');

    const effectiveClassId = classId || (lateClassData ? lateClassData.id : null);

    const { error } = await submitScore({
      playerName,
      classPeriod,
      faction: playerFaction,
      finalScore,
      baseScore: scores[playerFaction] || 0,
      objectiveBonus,
      factionMultiplier,
      nationalismMeter: nationalismMeter || 0,
      nativeResistance: nativeResistance || 0,
      navalDominance: navalDominance || 0,
      knowledgeCorrect: knowledgeCheckResults.correct,
      knowledgeTotal: knowledgeCheckResults.total,
      battlesWon: battleStats.won,
      battlesFought: battleStats.fought,
      territoriesHeld: playerTerritoryCount,
      roundsPlayed,
      gameOverReason,
      difficulty,
      sessionId,
      classId: effectiveClassId,
    });

    if (error) {
      setStatus('error');
      setErrorMsg(typeof error === 'string' ? error : error.message || 'Submission failed');
    } else {
      setStatus('success');
      markAsSubmitted(fingerprint);
      // Retroactively link quiz gate data if late join
      if (!classId && effectiveClassId && sessionId) {
        linkSessionToClass({ sessionId, classId: effectiveClassId }).catch(() => {});
      }
      if (onSubmitted) onSubmitted();
    }
  };
```

**Step 4: Add late join UI before the submit button**

In the `return` statement for the idle/error state (the `<div className="bg-black/20 ...">` block), add before the submit button:

```jsx
      {/* Late join: show class code field if student has no class */}
      {!classId && (
        <div className="mb-3 text-left">
          <p className="text-parchment-dark/50 text-xs font-body mb-1.5">
            Have a class code from your teacher?
          </p>
          <div className="flex gap-2">
            <input
              type="text"
              value={lateClassCode}
              onChange={(e) => {
                const val = e.target.value.toUpperCase().slice(0, 6);
                setLateClassCode(val);
                if (val.length === 6) handleLateValidate(val);
                else { setLateClassData(null); setLateClassError(''); }
              }}
              placeholder="ABC123"
              maxLength={6}
              className="flex-1 bg-war-ink/50 border border-parchment-dark/15 rounded px-3 py-2 text-parchment/90
                         placeholder-parchment-dark/30 font-body font-mono tracking-widest text-center uppercase text-sm
                         focus:border-war-gold/40 focus:outline-none transition-colors"
            />
          </div>
          {lateValidating && <p className="text-parchment-dark/40 text-xs mt-1 font-body italic">Checking...</p>}
          {lateClassError && <p className="text-red-400 text-xs mt-1 font-body">{lateClassError}</p>}
          {lateClassData && <p className="text-green-400 text-xs mt-1 font-body">Will submit to: {lateClassData.name}</p>}
        </div>
      )}
```

**Step 5: Build and test**

```bash
npx react-scripts build 2>&1 | tail -5
npx react-scripts test --watchAll=false 2>&1 | tail -5
```

**Step 6: Commit**

```bash
git add src/components/ScoreSubmission.jsx
git commit -m "Add late join class code field to ScoreSubmission"
```

---

### Task 6: Rewrite TeacherDashboard with Supabase Auth and class management

**Files:**
- Modify: `src/components/TeacherDashboard.jsx`

This is the largest single task. The entire component is rewritten. Rather than prescribing exact line edits on a ~470-line file, provide the complete new file content.

**Step 1: Write the complete new TeacherDashboard**

The new file must:

1. **Remove** the old `LoginGate` component and `verifyTeacherPassword` import
2. **Add** Supabase Auth imports: `signInWithMagicLink`, `signInWithPassword`, `signUpTeacher`, `signOut`, `getSession`, `onAuthStateChange`, `getTeacherProfile`, `createTeacherProfile`, `createClass`, `fetchTeacherClasses`
3. **Add** `AuthGate` component replacing `LoginGate`:
   - Email input + "Send Magic Link" button (primary)
   - "Use password instead" toggle → email + password + Sign In / Sign Up tabs
   - Loading/error states
   - Magic link sent confirmation message
4. **Add** `SetupProfile` component (first-time teacher):
   - Display name input → calls `createTeacherProfile`
5. **Add** `ClassManager` component:
   - List of classes with name, code, student count, "Copy Link" button
   - "Create Class" button → inline form with name input
   - Copy link copies `https://1812.mrbsocialstudies.org?class=CODE`
6. **Rewrite** `Dashboard` component:
   - `useEffect` to check auth session + fetch teacher profile + fetch classes
   - Fetch stats scoped to teacher's class IDs
   - Replace period-based aggregation with class-based aggregation
   - Header: "Welcome, [display_name]" + Sign Out
   - Classes section at top
   - Existing sections (summary cards, class breakdown, faction distribution, quiz gate analytics, all scores, CSV exports) all scoped by teacher's class IDs
   - Filter dropdown changes from period to class
   - Keep Game Guide section unchanged

The dashboard should follow the same War Room Cartography design system as the current one.

**Key patterns from the existing file to preserve:**
- `bg-war-navy/50 rounded-lg p-5 border border-parchment-dark/8` for section cards
- `text-war-gold/80 font-display text-base tracking-wide` for section headers
- `font-body` for body text, `font-display` for headings
- Table styles: `text-sm font-body`, `border-b border-parchment-dark/15` headers
- Button styles: `px-4 py-1.5 text-xs border border-parchment-dark/15 text-parchment-dark/50 rounded hover:border-war-gold/40 hover:text-war-gold`
- Primary button: `bg-war-gold text-war-ink font-display text-sm rounded hover:bg-war-brass`

**Step 2: Build and test**

```bash
npx react-scripts build 2>&1 | tail -5
npx react-scripts test --watchAll=false 2>&1 | tail -5
```

Expected: Build succeeds with 0 warnings, 105 tests pass.

**Step 3: Commit**

```bash
git add src/components/TeacherDashboard.jsx
git commit -m "Rewrite TeacherDashboard with Supabase Auth and class management"
```

---

### Task 7: Update teacher guide content

**Files:**
- Modify: `src/data/teacherGuide.js`

**Step 1: Update references to old password-based dashboard**

Find and replace all references to the teacher password and old dashboard workflow:

1. Line 109: Replace `'Set up the Teacher Dashboard (#teacher in URL) and note the password'` with `'Create your teacher account at #teacher (sign in with email)'`

2. Line 173: The content about Teacher Dashboard showing quiz performance is fine — just ensure it doesn't mention a password.

3. Line 189: `'Monitor Knowledge Check scores on the Teacher Dashboard during gameplay'` — this is fine as-is.

4. Line 257-258: Replace the FAQ answer:
   - Old: `'Add #teacher to the game URL. You\'ll need the teacher password. The dashboard shows class-wide analytics, quiz scores, and exportable CSV data.'`
   - New: `'Add #teacher to the game URL and sign in with your email. Create classes and share codes with students. The dashboard shows class-wide analytics, quiz scores, and exportable CSV data.'`

**Step 2: Build to verify**

```bash
npx react-scripts build 2>&1 | tail -5
```

**Step 3: Commit**

```bash
git add src/data/teacherGuide.js
git commit -m "Update teacher guide to reference new auth-based dashboard"
```

---

### Task 8: Update Teacher Quick Start doc

**Files:**
- Modify: `docs/TEACHER_QUICK_START.md`

**Step 1: Update dashboard access instructions**

Replace the line about password access (line 129):
- Old: `Access at: **https://1812.mrbsocialstudies.org/teacher** (password: \`teacher1812\`)`
- New: `Access at: **https://1812.mrbsocialstudies.org#teacher** — sign in with your email`

Add a section about class codes:
```markdown
### Class Codes
1. Sign in to the Teacher Dashboard (#teacher)
2. Click "Create Class" and enter a name (e.g., "Period 3")
3. Share the 6-character code with students, or copy the direct link
4. Students enter the code on the first screen, or use the link to auto-fill it
5. All student data (scores and quiz performance) will appear on your dashboard
```

**Step 2: Commit**

```bash
git add docs/TEACHER_QUICK_START.md
git commit -m "Update Teacher Quick Start for class code workflow"
```

---

### Task 9: Version bump, changelog, and README

**Files:**
- Modify: `src/data/changelog.js`
- Modify: `README.md`

**Step 1: Update changelog.js**

Change `CURRENT_VERSION` to `'2.0.0'`.

Add new changelog entry at top of array:

```javascript
  {
    version: '2.0.0',
    date: '2026-02-25',
    title: 'Class Code System',
    changes: [
      'Teacher accounts with Supabase Auth (magic link + password sign-in)',
      'Teachers create classes with shareable 6-character codes',
      'Students enter class code during onboarding or via direct link',
      'Teacher Dashboard shows only their students\' data (fully isolated)',
      'Late join — students can enter class code at score submission',
      'Quiz gate data and game scores linked to classes for teacher analytics',
      'Global leaderboard unchanged — all students still appear',
    ],
  },
```

**Step 2: Update README.md**

- Change version in header from `1.7.0` to `2.0.0`
- Replace "Latest Features" section header and add v2.0.0 section
- Add v2.0.0 row to version history table
- Update "Current Status" line
- Update "Backend" in tech stack to mention auth
- Update Teacher Resources to mention class codes

**Step 3: Build and test**

```bash
npx react-scripts build 2>&1 | tail -5
npx react-scripts test --watchAll=false 2>&1 | tail -5
```

**Step 4: Commit**

```bash
git add src/data/changelog.js README.md
git commit -m "Bump to v2.0.0 with Class Code System changelog and README"
```

---

### Task 10: Run Supabase migration and deploy

**Step 1: Configure Supabase Auth**

In Supabase Dashboard → Authentication → Providers:
- Ensure Email provider is enabled
- Under URL Configuration:
  - Site URL: `https://1812.mrbsocialstudies.org`
  - Redirect URLs: add `https://1812.mrbsocialstudies.org`

**Step 2: Run migration SQL**

Open Supabase SQL Editor and run `docs/migrations/002_class_code_system.sql`.

**Step 3: Verify policies**

```sql
SELECT tablename, policyname, roles, cmd
FROM pg_policies
WHERE tablename IN ('teachers', 'classes', 'scores', 'quiz_gate_results')
ORDER BY tablename, policyname;
```

**Step 4: Final build + test**

```bash
npx react-scripts build 2>&1 | tail -5
npx react-scripts test --watchAll=false 2>&1 | tail -5
```

**Step 5: Push and deploy**

```bash
git push
npm run deploy
```

---

## File Summary

| File | Action |
|------|--------|
| `docs/migrations/002_class_code_system.sql` | Create (migration reference) |
| `src/lib/supabase.js` | Modify (auth functions, class CRUD, scoped queries, remove password verify) |
| `src/App.js` | Modify (classId in onboarding, ?class= param, thread props) |
| `src/hooks/useGameStateV2.js` | Modify (store/expose classId) |
| `src/reducers/gameReducer.js` | Modify (classId in GAME_START/LOAD) |
| `src/components/NameEntry.jsx` | Modify (class code field replacing period) |
| `src/components/ScoreSubmission.jsx` | Modify (late join class code) |
| `src/components/GameBoard.jsx` | Modify (thread classId) |
| `src/components/GameReport.jsx` | Modify (thread classId) |
| `src/components/TeacherDashboard.jsx` | Full rewrite (auth, class management, scoped data) |
| `src/data/teacherGuide.js` | Modify (update password references) |
| `docs/TEACHER_QUICK_START.md` | Modify (new auth + class code instructions) |
| `src/data/changelog.js` | Modify (bump to 2.0.0) |
| `README.md` | Modify (version, features, tech stack) |

## Execution Order

1. **Migration SQL** (reference file, run in Supabase before deploying code)
2. **Supabase lib** (auth + class functions — foundation for everything else)
3. **Thread classId** (App.js, game state, reducers, component prop chain)
4. **NameEntry** (student-facing class code input)
5. **ScoreSubmission** (late join)
6. **TeacherDashboard** (biggest task — full rewrite)
7. **Teacher guide content** (data file update)
8. **Teacher Quick Start doc** (markdown update)
9. **Version bump** (changelog + README)
10. **Deploy** (Supabase config + migration + push)
